<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2016-12-02 Fri 15:25 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="viewport" content="width=device-width, initial-scale=1" />
<title></title>
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="b" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgheadline5">1. setting-up</a>
<ul>
<li><a href="#orgheadline1">1.1. steps</a></li>
<li><a href="#orgheadline4">1.2. considerations</a>
<ul>
<li><a href="#orgheadline2">1.2.1. printing to standard out</a></li>
<li><a href="#orgheadline3">1.2.2. idiomatic usage</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline10">2. loading namespaces and using the relevant vars</a>
<ul>
<li><a href="#orgheadline6">2.1. repl vs. babel</a></li>
<li><a href="#orgheadline9">2.2. see what's available</a>
<ul>
<li><a href="#orgheadline7">2.2.1. resources that have been loaded in the background</a></li>
<li><a href="#orgheadline8">2.2.2. background libraries</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline17">3. check basic sounds and levels</a>
<ul>
<li><a href="#orgheadline13">3.1. sin wave</a>
<ul>
<li><a href="#orgheadline11">3.1.1. basic</a></li>
<li><a href="#orgheadline12">3.1.2. louder</a></li>
</ul>
</li>
<li><a href="#orgheadline14">3.2. white noise</a></li>
<li><a href="#orgheadline16">3.3. loaded samples</a>
<ul>
<li><a href="#orgheadline15">3.3.1. piano</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline43">4. construct meaningful musical units</a>
<ul>
<li><a href="#orgheadline22">4.1. all-important idiom for playing a chord</a>
<ul>
<li><a href="#orgheadline18">4.1.1. simple middle C triad</a></li>
<li><a href="#orgheadline21">4.1.2. randomly voice an A7 flat9 sharp13, play chord as side-effect</a></li>
</ul>
</li>
<li><a href="#orgheadline32">4.2. remember meaningful phenomena</a>
<ul>
<li><a href="#orgheadline23">4.2.1. write 6 note voicing to disk</a></li>
<li><a href="#orgheadline24">4.2.2. stateful versions (?)</a></li>
<li><a href="#orgheadline25">4.2.3. using an atom and swap to derefence and set a new value</a></li>
<li><a href="#orgheadline26">4.2.4. let's make a cycle with a few more things</a></li>
<li><a href="#orgheadline27">4.2.5. working with stateful objects without atom management</a></li>
<li><a href="#orgheadline28">4.2.6. reading from and writing to disk</a></li>
<li><a href="#orgheadline29">4.2.7. we want to read-write with streams instead</a></li>
<li><a href="#orgheadline30">4.2.8. with-open and java file writing interop</a></li>
<li><a href="#orgheadline31">4.2.9. developing an understanding of state</a></li>
</ul>
</li>
<li><a href="#orgheadline42">4.3. playing a melody involves time idioms</a>
<ul>
<li><a href="#orgheadline33">4.3.1. start simply with 'this' moment</a></li>
<li><a href="#orgheadline36">4.3.2. using a metronome as timer for more sequenced items</a></li>
<li><a href="#orgheadline41">4.3.3. defined <code>play</code> doesn't have an example in the documentation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline48">5. generate large databases of musical events</a>
<ul>
<li><a href="#orgheadline44">5.1. transpose triply nested list</a></li>
<li><a href="#orgheadline46">5.2. start working with keyworded maps instead of unadorned lists</a>
<ul>
<li><a href="#orgheadline45">5.2.1. basic uses of hashes (sets)</a></li>
</ul>
</li>
<li><a href="#orgheadline47">5.3. note names vs. midi numbers&#x2013;note vs. find-note-name</a></li>
</ul>
</li>
<li><a href="#orgheadline49">6. data</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgheadline5" class="outline-2">
<h2 id="orgheadline5"><span class="section-number-2">1</span> setting-up</h2>
<div class="outline-text-2" id="text-1">
<p>
Each tutorial assumes you are starting up cold. While actually doing
so may seem an inconvenience (why would you ever want to leave
emacs??), it actuall is a good practice, akin to a conceptual and
code spring-cleaning.
</p>
</div>
<div id="outline-container-orgheadline1" class="outline-3">
<h3 id="orgheadline1"><span class="section-number-3">1.1</span> steps</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Once you have followed the below steps:
</p>

<ol class="org-ol">
<li></li>
</ol>

<div class="org-src-container">

<pre class="src src-bash"><span style="color: #DCDCCC; font-weight: bold;">cd</span> ~/git-projects/post_tonal_overtone
lein repl
</pre>
</div>

<p>
or <code>cider-jack-in</code> from within the post<sub>tonal</sub><sub>overtone</sub>
directory within emacs
</p>

<ol class="org-ol">
<li></li>
</ol>

<p>
evaluate (C-c C-k using CIDER) the post<sub>tonal</sub><sub>definitions.clj</sub> file 
</p>

<p>
You will hopefully see overtone loading up in your cider-repl.
</p>
</div>
</div>

<div id="outline-container-orgheadline4" class="outline-3">
<h3 id="orgheadline4"><span class="section-number-3">1.2</span> considerations</h3>
<div class="outline-text-3" id="text-1-2">
</div><div id="outline-container-orgheadline2" class="outline-4">
<h4 id="orgheadline2"><span class="section-number-4">1.2.1</span> printing to standard out</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
One advantage to starting a lein repl and then connecting cider to it
(with cider-connect) is that the terminal window (which becomes
dedicated to the overtone server once overtone is loaded) seems happy
to <code>println</code> things that cider-repl doesn't. 
</p>

<p>
For example see this function from an earlier section.
</p>
<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">voice-and-transpose-rand-set</span> [set-type tn-level]
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> [set (rand-nth set-type)
        voiced-set (map #(+ (rand-nth [36 48 60 72]) <span style="color: #DFAF8F;">%</span>) set)
        visible-pairings (map #(list <span style="color: #DFAF8F;">%</span> (mod <span style="color: #DFAF8F;">%</span> 12)) voiced-set)
        transposed-set (map #(+ tn-level <span style="color: #DFAF8F;">%</span>) voiced-set)
        paired-transposed-set (map #(list (mod <span style="color: #DFAF8F;">%</span> 12) (+ tn-level <span style="color: #DFAF8F;">%</span>)) (sort voiced-set))
        set-voicing-group (list <span style="color: #BFEBBF;">:set</span> set
                                <span style="color: #BFEBBF;">:tn-level</span> tn-level
                                <span style="color: #BFEBBF;">:reg</span> visible-pairings
                                <span style="color: #BFEBBF;">:sorted-trans</span> paired-transposed-set)]
    (<span style="color: #F0DFAF; font-weight: bold;">do</span>
      (println set-voicing-group)
      #_<span style="color: #7F9F7F;">set-voicing-group</span> transposed-set)))

(voice-and-transpose-rand-set trichords 3)

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(voice-and-transpose-rand-set set-class/trichords 3)</span>
</pre>
</div>



<p>
Also, note that whether you start cider from within the /src directory
or the project directory will make a difference. Use the top-level
project directory, with the project.clj file.
</p>
</div>
</div>

<div id="outline-container-orgheadline3" class="outline-4">
<h4 id="orgheadline3"><span class="section-number-4">1.2.2</span> idiomatic usage</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
What's the best way to set-up and define functions? For example the
above function is perhaps a little on the large side, and appears to
be doing a lot in the span of its one let form. Additionally, the
function as it is written is called with two arguments&#x2013;is there
another way to do this that would present any relative advantages?
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-orgheadline10" class="outline-2">
<h2 id="orgheadline10"><span class="section-number-2">2</span> loading namespaces and using the relevant vars</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-orgheadline6" class="outline-3">
<h3 id="orgheadline6"><span class="section-number-3">2.1</span> repl vs. babel</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Again, there's more than one way to do this. You can choose to have
babel-blocks do the loading, but in this case the repl will remain
ignorant of what has been taking place (this hasn't always seemed to
be the case when working with both. But for whatever I have done, it
always seems to be the case now).
</p>

<p>
Maybe name a session to help learn about how babel and cider will
interact around namespaces
</p>

<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #F0DFAF; font-weight: bold;">in-ns</span> '<span style="color: #7CB8BB;">post_tonal_overtone.core</span>)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-clojure"><span style="color: #DCDCCC; font-weight: bold;">*ns*</span>
</pre>
</div>

<div class="org-src-container">

<pre class="src src-clojure"><span style="color: #DCDCCC; font-weight: bold;">*ns*</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline9" class="outline-3">
<h3 id="orgheadline9"><span class="section-number-3">2.2</span> see what's available</h3>
<div class="outline-text-3" id="text-2-2">
</div><div id="outline-container-orgheadline7" class="outline-4">
<h4 id="orgheadline7"><span class="section-number-4">2.2.1</span> resources that have been loaded in the background</h4>
<div class="outline-text-4" id="text-2-2-1">
<p>
Do you have access to certain data structures you are going to want to
use? If not, how do you load these things?
</p>

<p>
A "cheap" way is just to go to a file that contains such a <code>def</code>
statement and evaluate it right there
</p>
<div class="org-src-container">

<pre class="src src-clojure">cmajtriads
</pre>
</div>

<div class="org-src-container">

<pre class="src src-clojure"><span style="color: #7CB8BB;">set-class</span><span style="color: #DCDCCC; background-color: #3F3F3F;">/</span>cmajtriads
</pre>
</div>
</div>
</div>



<div id="outline-container-orgheadline8" class="outline-4">
<h4 id="orgheadline8"><span class="section-number-4">2.2.2</span> background libraries</h4>
<div class="outline-text-4" id="text-2-2-2">
<p>
What about libraries of functions that you might want to use? What
kind of namespace-qualification are you going to have to use? Will you
need to <code>use</code> anything directly?
</p>

<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #7CB8BB;">finite-prob</span><span style="color: #DCDCCC; background-color: #3F3F3F;">/</span>certainly 11)
</pre>
</div>

<p>
Take a look at some of the vars defined in other namespaces. Do you
know what they are, or how to use them? 
</p>

<p>
How far should you go with trying to document what you're using?
Personally, I like to err on the side of overly comprehensive, which
working with emacs and org-mode makes possible and not excessively
distracting.
</p>

<div class="org-src-container">

<pre class="src src-clojure">(dir <span style="color: #7CB8BB;">post_tonal_overtone.probability_functions.finite-distributions</span>)
</pre>
</div>

<p>
Note, during all this loading and checking, you may have received
mysterious errors. Have you checked your REPL lately? There may be
subtle spelling or procedural mistakes that you have made which you
will want to "debug" from the sometimes obscure error messages you
receive.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgheadline17" class="outline-2">
<h2 id="orgheadline17"><span class="section-number-2">3</span> check basic sounds and levels</h2>
<div class="outline-text-2" id="text-3">
<p>
This is akin to what happens at live shows, where the musician's and
sound engineers do "sound checks" (or really "line checks," in the
case of just making sure everything is working).
</p>
</div>
<div id="outline-container-orgheadline13" class="outline-3">
<h3 id="orgheadline13"><span class="section-number-3">3.1</span> sin wave</h3>
<div class="outline-text-3" id="text-3-1">
</div><div id="outline-container-orgheadline11" class="outline-4">
<h4 id="orgheadline11"><span class="section-number-4">3.1.1</span> basic</h4>
<div class="outline-text-4" id="text-3-1-1">
<div class="org-src-container">

<pre class="src src-clojure">(demo (sin-osc))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline12" class="outline-4">
<h4 id="orgheadline12"><span class="section-number-4">3.1.2</span> louder</h4>
<div class="outline-text-4" id="text-3-1-2">
<div class="org-src-container">

<pre class="src src-clojure">(demo  (out 0 (* 2 (sin-osc))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgheadline14" class="outline-3">
<h3 id="orgheadline14"><span class="section-number-3">3.2</span> white noise</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">

<pre class="src src-clojure">(demo (white-noise))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline16" class="outline-3">
<h3 id="orgheadline16"><span class="section-number-3">3.3</span> loaded samples</h3>
<div class="outline-text-3" id="text-3-3">
</div><div id="outline-container-orgheadline15" class="outline-4">
<h4 id="orgheadline15"><span class="section-number-4">3.3.1</span> piano</h4>
<div class="outline-text-4" id="text-3-3-1">
<div class="org-src-container">

<pre class="src src-clojure">(sampled-piano)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-clojure">(sampled-piano (note <span style="color: #BFEBBF;">:A4</span>))
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-orgheadline43" class="outline-2">
<h2 id="orgheadline43"><span class="section-number-2">4</span> construct meaningful musical units</h2>
<div class="outline-text-2" id="text-4">
<p>
In all the tutorials so far we have used the <code>doseq</code> function. Here it
is again, taken out of context and with some imagined function body
after the initial binding form.
</p>
</div>
<div id="outline-container-orgheadline22" class="outline-3">
<h3 id="orgheadline22"><span class="section-number-3">4.1</span> all-important idiom for playing a chord</h3>
<div class="outline-text-3" id="text-4-1">
<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #F0DFAF; font-weight: bold;">doseq</span> [note a-chord] <span style="color: #5F7F5F;">;;</span><span style="color: #7F9F7F;">pseudocode (player-function note))</span>
</pre>
</div>
</div>
<div id="outline-container-orgheadline18" class="outline-4">
<h4 id="orgheadline18"><span class="section-number-4">4.1.1</span> simple middle C triad</h4>
<div class="outline-text-4" id="text-4-1-1">
<p>
So begin to note how the <code>doseq</code> function does what it does, which is
especially useful to us when we are interested in doing something
repetitive like playing all the notes in a chord.
</p>

<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">play-piano-chord</span> [a-chord]
        (<span style="color: #F0DFAF; font-weight: bold;">doseq</span> [note a-chord] (sampled-piano note)))

(play-piano-chord [60 64 67])
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline21" class="outline-4">
<h4 id="orgheadline21"><span class="section-number-4">4.1.2</span> randomly voice an A7 flat9 sharp13, play chord as side-effect</h4>
<div class="outline-text-4" id="text-4-1-2">
<p>
So, with that reminder of how we can tidily play chords, we can now
look a little more deeply at some techniques for accessing and
rendering chords as built in to overtone.
</p>
</div>

<ol class="org-ol"><li><a id="orgheadline19"></a>4 note voicings using built-in overtone functionality<br  /><div class="outline-text-5" id="text-4-1-2-1">
<p>
In the last tutorial, I spent most of my time dealing with the kinds
of harmonies that characterize post-tonal music. Overtone, however,
has ample support for the harmonic organization that typifies tonal
music, that is the chords and scales of Western (and some non-Western)
music. 
</p>

<p>
Without going into too much of a digression on the sometimes
overly-casual distinctions between tonal, post-tonal and "centric"
music, let's just look at (and listen to) a quick cool bit of
functionality.
</p>

<div class="org-src-container">

<pre class="src src-clojure"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">overtone.live/rand-chord</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">([root chord-name num-pitches pitch-range])</span>
<span style="color: #5F7F5F;">;;   </span><span style="color: #7F9F7F;">Generates a random list of MIDI notes with cardinality num-pitches</span>
<span style="color: #5F7F5F;">;;   </span><span style="color: #7F9F7F;">bound within the range of the specified root and pitch-range and</span>
<span style="color: #5F7F5F;">;;   </span><span style="color: #7F9F7F;">only containing pitches within the specified chord-name. Similar to</span>
<span style="color: #5F7F5F;">;;   </span><span style="color: #7F9F7F;">Impromptu's pc:make-chord</span>

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">mod12</span> [n] (mod n 12))

(<span style="color: #F0DFAF; font-weight: bold;">let</span> [midis (rand-chord <span style="color: #BFEBBF;">:A2</span> <span style="color: #BFEBBF;">:7+5-9</span> 4 48)]
(<span style="color: #F0DFAF; font-weight: bold;">do</span> (println (map find-note-name midis))
    (println midis)
    (println (map mod12 midis))
    (play-piano-chord midis)
  ))
</pre>
</div>

<p>
Overtone supplies a rich set of built-in keyword args for dealing with
a system of naming chords that is common to jazz and 20th century
popular music: a mix of names and Arabic numberal, with a few odd
other symbols thrown in there.
</p>

<p>
Consulting the overtone documentation for chord only gives a small
picture of what actually is available when we crack open the overtone
<code>pitch.clj</code> source file.
</p>

<div class="org-src-container">

<pre class="src src-clojure">(source chord)
</pre>
</div>
</div></li>

<li><a id="orgheadline20"></a>pitch.clj source<br  /><div class="outline-text-5" id="text-4-1-2-2">
<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #F0DFAF; font-weight: bold;">ns</span> ^{<span style="color: #BFEBBF;">:doc</span> <span style="color: #CC9393;">"Functions to help generate and manipulate frequencies and</span>
<span style="color: #CC9393;">    sets of related frequencies. This is the place for functions</span>
<span style="color: #CC9393;">    representing general musical knowledge, like scales, chords,</span>
<span style="color: #CC9393;">    intervals, etc."</span>
      <span style="color: #BFEBBF;">:author</span> <span style="color: #CC9393;">"Jeff Rose, Sam Aaron &amp; Marius Kempe"</span>}
  <span style="color: #7CB8BB;">overtone.music.pitch</span>
  (<span style="color: #BFEBBF;">:use</span> [<span style="color: #7CB8BB;">overtone.helpers</span> old-contrib]
        [<span style="color: #7CB8BB;">overtone.helpers.map</span> <span style="color: #BFEBBF;">:only</span> [reverse-get]]
        [<span style="color: #7CB8BB;">overtone.algo</span> chance])
  (<span style="color: #BFEBBF;">:require</span> [<span style="color: #7CB8BB;">clojure.string</span> <span style="color: #BFEBBF;">:as</span> string]))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">Notes in a typical scale are related by small, prime number ratios. Of all</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">possible 7 note scales, the major scale has the highest number of consonant</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">intervals.</span>

(<span style="color: #F0DFAF; font-weight: bold;">defmacro</span> <span style="color: #93E0E3;">defratio</span> [rname ratio]
  `(<span style="color: #F0DFAF; font-weight: bold;">defn</span> ~rname [freq#] (* freq# ~ratio)))

<span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">Perfect consonance</span>
(<span style="color: #F0DFAF; font-weight: bold;">defratio</span> <span style="color: #93E0E3;">unison</span>    1/1)
(<span style="color: #F0DFAF; font-weight: bold;">defratio</span> <span style="color: #93E0E3;">octave</span>    2/1)
(<span style="color: #F0DFAF; font-weight: bold;">defratio</span> <span style="color: #93E0E3;">fifth</span>     3/2)

<span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">Imperfect consonance</span>
(<span style="color: #F0DFAF; font-weight: bold;">defratio</span> <span style="color: #93E0E3;">sixth</span>     5/3)
(<span style="color: #F0DFAF; font-weight: bold;">defratio</span> <span style="color: #93E0E3;">third</span>     5/4)

<span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">Dissonance</span>
(<span style="color: #F0DFAF; font-weight: bold;">defratio</span> <span style="color: #93E0E3;">fourth</span>    4/3)
(<span style="color: #F0DFAF; font-weight: bold;">defratio</span> <span style="color: #93E0E3;">min-third</span> 6/5)
(<span style="color: #F0DFAF; font-weight: bold;">defratio</span> <span style="color: #93E0E3;">min-sixth</span> 8/5)

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">cents</span>
  <span style="color: #9FC59F;">"Returns a frequency computed by adding n-cents to freq.  A cent is</span>
<span style="color: #9FC59F;">  a logarithmic measurement of pitch, where 1-octave equals 1200</span>
<span style="color: #9FC59F;">  cents."</span>
  [freq n-cents]
  (* freq (<span style="color: #7CB8BB;">java.lang.Math</span><span style="color: #DCDCCC; background-color: #3F3F3F;">/</span>pow 2 (/ n-cents 1200))))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">MIDI</span>
(<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #DFAF8F;">MIDI-RANGE</span> (range 128))
(<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #DFAF8F;">MIDDLE-C</span> 60)

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">Manipulating pitch using midi note numbers</span>

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">shift</span>
  <span style="color: #9FC59F;">"Shift the 'notes' in 'phrase' by a given 'amount' of half-steps."</span>
  [phrase notes amount]
  (<span style="color: #F0DFAF; font-weight: bold;">if</span> notes
    (<span style="color: #F0DFAF; font-weight: bold;">let</span> [note (first notes)
          shifted (+ (get phrase note) amount)]
      (<span style="color: #F0DFAF; font-weight: bold;">recur</span> (assoc phrase note shifted) (next notes) amount))
    phrase))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">flat</span>
  <span style="color: #9FC59F;">"Flatten the specified notes in the phrase."</span>
  [phrase notes]
  (shift phrase notes -1))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">sharp</span>
  <span style="color: #9FC59F;">"Sharpen the specified notes in the phrase."</span>
  [phrase notes]
  (shift phrase notes +1))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">invert</span>
  <span style="color: #9FC59F;">"Invert a sequence of notes using either the first note as the</span>
<span style="color: #9FC59F;">  stationary pivot point or the optional second argument."</span>
  [notes &amp; [pivot]]
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> [pivot (<span style="color: #F0DFAF; font-weight: bold;">or</span> pivot (first notes))]
    (<span style="color: #F0DFAF; font-weight: bold;">for</span> [n notes] (- pivot (- n pivot)))))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">octave-note</span>
  <span style="color: #9FC59F;">"Convert an octave and interval to a midi note."</span>
  [octave interval]
  (+ (* octave 12) interval 12))

(<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #DFAF8F;">NOTES</span> {<span style="color: #BFEBBF;">:C</span>  0  <span style="color: #BFEBBF;">:c</span>  0  <span style="color: #BFEBBF;">:b#</span> 0  <span style="color: #BFEBBF;">:B#</span> 0
            <span style="color: #BFEBBF;">:C#</span> 1  <span style="color: #BFEBBF;">:c#</span> 1  <span style="color: #BFEBBF;">:Db</span> 1  <span style="color: #BFEBBF;">:db</span> 1  <span style="color: #BFEBBF;">:DB</span> 1  <span style="color: #BFEBBF;">:dB</span> 1
            <span style="color: #BFEBBF;">:D</span>  2  <span style="color: #BFEBBF;">:d</span>  2
            <span style="color: #BFEBBF;">:D#</span> 3  <span style="color: #BFEBBF;">:d#</span> 3  <span style="color: #BFEBBF;">:Eb</span> 3  <span style="color: #BFEBBF;">:eb</span> 3  <span style="color: #BFEBBF;">:EB</span> 3  <span style="color: #BFEBBF;">:eB</span> 3
            <span style="color: #BFEBBF;">:E</span>  4  <span style="color: #BFEBBF;">:e</span>  4
            <span style="color: #BFEBBF;">:E#</span> 5  <span style="color: #BFEBBF;">:e#</span> 5  <span style="color: #BFEBBF;">:F</span>  5  <span style="color: #BFEBBF;">:f</span>  5
            <span style="color: #BFEBBF;">:F#</span> 6  <span style="color: #BFEBBF;">:f#</span> 6  <span style="color: #BFEBBF;">:Gb</span> 6  <span style="color: #BFEBBF;">:gb</span> 6  <span style="color: #BFEBBF;">:GB</span> 6  <span style="color: #BFEBBF;">:gB</span> 6
            <span style="color: #BFEBBF;">:G</span>  7  <span style="color: #BFEBBF;">:g</span>  7
            <span style="color: #BFEBBF;">:G#</span> 8  <span style="color: #BFEBBF;">:g#</span> 8  <span style="color: #BFEBBF;">:Ab</span> 8  <span style="color: #BFEBBF;">:ab</span> 8  <span style="color: #BFEBBF;">:AB</span> 8  <span style="color: #BFEBBF;">:aB</span> 8
            <span style="color: #BFEBBF;">:A</span>  9  <span style="color: #BFEBBF;">:a</span>  9
            <span style="color: #BFEBBF;">:A#</span> 10 <span style="color: #BFEBBF;">:a#</span> 10 <span style="color: #BFEBBF;">:Bb</span> 10 <span style="color: #BFEBBF;">:bb</span> 10 <span style="color: #BFEBBF;">:BB</span> 10 <span style="color: #BFEBBF;">:bB</span> 10
            <span style="color: #BFEBBF;">:B</span>  11 <span style="color: #BFEBBF;">:b</span>  11 <span style="color: #BFEBBF;">:Cb</span> 11 <span style="color: #BFEBBF;">:cb</span> 11 <span style="color: #BFEBBF;">:CB</span> 11 <span style="color: #BFEBBF;">:cB</span> 11})

(<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #DFAF8F;">REVERSE-NOTES</span>
  {0 <span style="color: #BFEBBF;">:C</span>
   1 <span style="color: #BFEBBF;">:C#</span>
   2 <span style="color: #BFEBBF;">:D</span>
   3 <span style="color: #BFEBBF;">:Eb</span>
   4 <span style="color: #BFEBBF;">:E</span>
   5 <span style="color: #BFEBBF;">:F</span>
   6 <span style="color: #BFEBBF;">:F#</span>
   7 <span style="color: #BFEBBF;">:G</span>
   8 <span style="color: #BFEBBF;">:Ab</span>
   9 <span style="color: #BFEBBF;">:A</span>
   10 <span style="color: #BFEBBF;">:Bb</span>
   11 <span style="color: #BFEBBF;">:B</span>})

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">canonical-pitch-class-name</span>
  <span style="color: #9FC59F;">"Returns the canonical version of the specified pitch class pc."</span>
  [pc]
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> [pc (keyword (name pc))]
      (REVERSE-NOTES (<span style="color: #BFEBBF;">NOTES</span> pc))))

(<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #DFAF8F;">MIDI-NOTE-RE-STR</span> <span style="color: #9FC59F;">"([a-gA-G][#bB]?)([-0-9]+)"</span> )
(<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #DFAF8F;">MIDI-NOTE-RE</span> (re-pattern MIDI-NOTE-RE-STR))
(<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #DFAF8F;">ONLY-MIDI-NOTE-RE</span> (re-pattern (str <span style="color: #CC9393;">"</span><span style="color: #CC9393; font-weight: bold;">\\</span><span style="color: #CC9393;">A"</span> MIDI-NOTE-RE-STR <span style="color: #CC9393;">"</span><span style="color: #CC9393; font-weight: bold;">\\</span><span style="color: #CC9393;">Z"</span>)))

(<span style="color: #F0DFAF; font-weight: bold;">defn-</span> <span style="color: #93E0E3;">midi-string-matcher</span>
  <span style="color: #9FC59F;">"Determines whether a midi keyword is valid or not. If valid,</span>
<span style="color: #9FC59F;">  returns a regexp match object"</span>
  [mk]
  (re-find ONLY-MIDI-NOTE-RE (name mk)))

(<span style="color: #F0DFAF; font-weight: bold;">defn-</span> <span style="color: #93E0E3;">validate-midi-string!</span>
  <span style="color: #9FC59F;">"Throws a friendly exception if midi-keyword mk is not</span>
<span style="color: #9FC59F;">  valid. Returns matches if valid."</span>
  [mk]
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> [matches (midi-string-matcher mk)]
    (<span style="color: #F0DFAF; font-weight: bold;">when-not</span> matches
      (<span style="color: #F0DFAF; font-weight: bold;">throw</span> (<span style="color: #7CB8BB;">IllegalArgumentException.</span>
              (str <span style="color: #CC9393;">"Invalid midi-string. "</span> mk
                   <span style="color: #CC9393;">" does not appear to be in MIDI format i.e. C#4"</span>))))

    (<span style="color: #F0DFAF; font-weight: bold;">let</span> [[match pictch-class octave] matches]
      (<span style="color: #F0DFAF; font-weight: bold;">when</span> (&lt; (<span style="color: #7CB8BB;">Integer.</span> octave) -1)
        (<span style="color: #F0DFAF; font-weight: bold;">throw</span> (<span style="color: #7CB8BB;">IllegalArgumentException.</span>
                (str <span style="color: #CC9393;">"Invalid midi-string: "</span> mk
                     <span style="color: #CC9393;">". Octave is out of range. Lowest octave value is -1"</span>)))))
    matches))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">note-info</span>
  <span style="color: #9FC59F;">"Takes a string representing a midi note such as C4 and returns a map</span>
<span style="color: #9FC59F;">  of note info"</span>
  [midi-string]
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> [[match pitch-class octave] (validate-midi-string! midi-string)
        pitch-class                (canonical-pitch-class-name pitch-class)
        octave                     (<span style="color: #7CB8BB;">Integer.</span> octave)
        interval                   (<span style="color: #BFEBBF;">NOTES</span> (keyword pitch-class))]
    {<span style="color: #BFEBBF;">:match</span>       match
     <span style="color: #BFEBBF;">:pitch-class</span> pitch-class
     <span style="color: #BFEBBF;">:octave</span>      (<span style="color: #7CB8BB;">Integer.</span> octave)
     <span style="color: #BFEBBF;">:interval</span>    interval
     <span style="color: #BFEBBF;">:midi-note</span>   (octave-note octave interval)}))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">mk-midi-string</span>
  <span style="color: #9FC59F;">"Takes a string or keyword representing a pitch and a number</span>
<span style="color: #9FC59F;">  representing an integer and returns a new string which is a</span>
<span style="color: #9FC59F;">  concatanation of the two. Throws an error if the resulting midi</span>
<span style="color: #9FC59F;">  string is invalid.</span>

<span style="color: #9FC59F;">  (midi-string </span><span style="color: #BFEBBF;">:F</span><span style="color: #9FC59F;"> 7)  ;=&gt; \"F7\"</span>
<span style="color: #9FC59F;">  (midi-string </span><span style="color: #BFEBBF;">:Eb</span><span style="color: #9FC59F;"> 3) ;=&gt; \"Eb3\""</span>
  [pitch-key octave]
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> [res (str (name pitch-key) octave)]
    (validate-midi-string! res)
    res))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">note</span>
  <span style="color: #9FC59F;">"Resolves note to MIDI number format. Resolves upper and lower-case</span>
<span style="color: #9FC59F;">  keywords and strings in MIDI note format. If given an integer or</span>
<span style="color: #9FC59F;">  nil, returns them unmodified. All other inputs will raise an</span>
<span style="color: #9FC59F;">  exception.</span>

<span style="color: #9FC59F;">  Usage examples:</span>

<span style="color: #9FC59F;">  (note \"C4\")  ;=&gt; 60</span>
<span style="color: #9FC59F;">  (note \"C#4\") ;=&gt; 61</span>
<span style="color: #9FC59F;">  (note \"eb2\") ;=&gt; 39</span>
<span style="color: #9FC59F;">  (note </span><span style="color: #BFEBBF;">:F#7</span><span style="color: #9FC59F;">)    ;=&gt; 102</span>
<span style="color: #9FC59F;">  (note </span><span style="color: #BFEBBF;">:db5</span><span style="color: #9FC59F;">)    ;=&gt; 73</span>
<span style="color: #9FC59F;">  (note 60)      ;=&gt; 60</span>
<span style="color: #9FC59F;">  (note nil)     ;=&gt; nil"</span>
  [n]
  (<span style="color: #F0DFAF; font-weight: bold;">cond</span>
    (nil? n) <span style="color: #BFEBBF;">nil</span>
    (integer? n) (<span style="color: #F0DFAF; font-weight: bold;">if</span> (&gt;= n 0)
                   n
                   (<span style="color: #F0DFAF; font-weight: bold;">throw</span> (<span style="color: #7CB8BB;">IllegalArgumentException.</span>
                           (str <span style="color: #CC9393;">"Unable to resolve note: "</span>
                                n
                                <span style="color: #CC9393;">". Value is out of range. Lowest value is 0"</span>))))
    (keyword? n) (note (name n))
    (string? n) (<span style="color: #BFEBBF;">:midi-note</span> (note-info n))
    <span style="color: #BFEBBF;">:else</span> (<span style="color: #F0DFAF; font-weight: bold;">throw</span> (<span style="color: #7CB8BB;">IllegalArgumentException.</span> (str <span style="color: #CC9393;">"Unable to resolve note: "</span> n <span style="color: #CC9393;">". Wasn't a recognised format (either an integer, keyword, string or nil)"</span>)))))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">match-note</span>
  <span style="color: #9FC59F;">"Returns the first midi-note formatted substring in s. If passed</span>
<span style="color: #9FC59F;">   optional prev and pos strings will use them to generate positive</span>
<span style="color: #9FC59F;">   look ahead and behind matchers. "</span>
  ([s] (match-note s <span style="color: #CC9393;">""</span> <span style="color: #CC9393;">""</span>))
  ([s prev-str post-str]
     (<span style="color: #F0DFAF; font-weight: bold;">let</span> [look-behind (<span style="color: #F0DFAF; font-weight: bold;">if</span> prev-str (str <span style="color: #CC9393;">"(?&lt;="</span> prev-str <span style="color: #CC9393;">")"</span>) <span style="color: #CC9393;">""</span>)
           look-ahead  (<span style="color: #F0DFAF; font-weight: bold;">if</span> post-str (str <span style="color: #CC9393;">"(?="</span> post-str <span style="color: #CC9393;">")"</span>) <span style="color: #CC9393;">""</span>)
           match       (re-find (re-pattern (str look-behind MIDI-NOTE-RE-STR look-ahead)) s)]
       (<span style="color: #F0DFAF; font-weight: bold;">when</span> match
         (<span style="color: #F0DFAF; font-weight: bold;">let</span> [[match pitch-class octave] match]
           (note-info match))))))



<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">* Each note in a scale acts as either a generator or a collector of other notes,</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">depending on their relations in time within a sequence.</span>
<span style="color: #5F7F5F;">;;  </span><span style="color: #7F9F7F;">- How can this concept be developed into parameterized sequences with knobs for</span>
<span style="color: #5F7F5F;">;;  </span><span style="color: #7F9F7F;">adjusting things like tension, dissonance, swing, genre (latin, asian, arabic...)</span>
<span style="color: #5F7F5F;">;;  </span><span style="color: #7F9F7F;">- Can we develop a symbol language or visual representation so that someone could compose</span>
<span style="color: #5F7F5F;">;;  </span><span style="color: #7F9F7F;">a piece by using mood tokens rather than specifying scales and notes directly?  Basically,</span>
<span style="color: #5F7F5F;">;;  </span><span style="color: #7F9F7F;">generator functions would have to choose the scales, chords, notes and rhythm based on</span>
<span style="color: #5F7F5F;">;;  </span><span style="color: #7F9F7F;">a mix of looking up aspects of the mood, and informed randomness.</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">Use a note (</span><span style="color: #BFEBBF;">:C</span><span style="color: #7F9F7F;"> scale) or (</span><span style="color: #BFEBBF;">:Eb</span><span style="color: #7F9F7F;"> scale)</span>

<span style="color: #5F7F5F;">;;  </span><span style="color: #7F9F7F;">You may be interested to know that each of the seven degrees of the diatonic scale has its own name:</span>
<span style="color: #5F7F5F;">;;</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">1 (do)  tonic</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">2 (re)  supertonic</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">3 (mi)  mediant</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">4 (fa)  subdominant</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">5 (sol) dominant</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">6 (la)  submediant/superdominant</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">7 (ti)  subtonic"</span>


<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">Various scale intervals in terms of steps on a piano, or midi note numbers</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">All sequences should add up to 12 - the number of semitones in an octave</span>

(<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #DFAF8F;">SCALE</span>
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> [ionian-sequence     [2 2 1 2 2 2 1]
        hex-sequence        [2 2 1 2 2 3]
        pentatonic-sequence [3 2 2 3 2]
        rotate (<span style="color: #F0DFAF; font-weight: bold;">fn</span> [scale-sequence offset]
                 (take (count scale-sequence)
                       (drop offset (cycle scale-sequence))))]
    {<span style="color: #BFEBBF;">:diatonic</span>           ionian-sequence
     <span style="color: #BFEBBF;">:ionian</span>             (rotate ionian-sequence 0)
     <span style="color: #BFEBBF;">:major</span>              (rotate ionian-sequence 0)
     <span style="color: #BFEBBF;">:dorian</span>             (rotate ionian-sequence 1)
     <span style="color: #BFEBBF;">:phrygian</span>           (rotate ionian-sequence 2)
     <span style="color: #BFEBBF;">:lydian</span>             (rotate ionian-sequence 3)
     <span style="color: #BFEBBF;">:mixolydian</span>         (rotate ionian-sequence 4)
     <span style="color: #BFEBBF;">:aeolian</span>            (rotate ionian-sequence 5)
     <span style="color: #BFEBBF;">:minor</span>              (rotate ionian-sequence 5)
     <span style="color: #BFEBBF;">:locrian</span>            (rotate ionian-sequence 6)
     <span style="color: #BFEBBF;">:hex-major6</span>         (rotate hex-sequence 0)
     <span style="color: #BFEBBF;">:hex-dorian</span>         (rotate hex-sequence 1)
     <span style="color: #BFEBBF;">:hex-phrygian</span>       (rotate hex-sequence 2)
     <span style="color: #BFEBBF;">:hex-major7</span>         (rotate hex-sequence 3)
     <span style="color: #BFEBBF;">:hex-sus</span>            (rotate hex-sequence 4)
     <span style="color: #BFEBBF;">:hex-aeolian</span>        (rotate hex-sequence 5)
     <span style="color: #BFEBBF;">:minor-pentatonic</span>   (rotate pentatonic-sequence 0)
     <span style="color: #BFEBBF;">:yu</span>                 (rotate pentatonic-sequence 0)
     <span style="color: #BFEBBF;">:major-pentatonic</span>   (rotate pentatonic-sequence 1)
     <span style="color: #BFEBBF;">:gong</span>               (rotate pentatonic-sequence 1)
     <span style="color: #BFEBBF;">:egyptian</span>           (rotate pentatonic-sequence 2)
     <span style="color: #BFEBBF;">:shang</span>              (rotate pentatonic-sequence 2)
     <span style="color: #BFEBBF;">:jiao</span>               (rotate pentatonic-sequence 3)
     <span style="color: #BFEBBF;">:pentatonic</span>         (rotate pentatonic-sequence 4) <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">historical match</span>
     <span style="color: #BFEBBF;">:zhi</span>                (rotate pentatonic-sequence 4)
     <span style="color: #BFEBBF;">:ritusen</span>            (rotate pentatonic-sequence 4)
     <span style="color: #BFEBBF;">:whole-tone</span>         [2 2 2 2 2 2]
     <span style="color: #BFEBBF;">:whole</span>              [2 2 2 2 2 2]
     <span style="color: #BFEBBF;">:chromatic</span>          [1 1 1 1 1 1 1 1 1 1 1 1]
     <span style="color: #BFEBBF;">:harmonic-minor</span>     [2 1 2 2 1 3 1]
     <span style="color: #BFEBBF;">:melodic-minor-asc</span>  [2 1 2 2 2 2 1]
     <span style="color: #BFEBBF;">:hungarian-minor</span>    [2 1 3 1 1 3 1]
     <span style="color: #BFEBBF;">:octatonic</span>          [2 1 2 1 2 1 2 1]
     <span style="color: #BFEBBF;">:messiaen1</span>          [2 2 2 2 2 2]
     <span style="color: #BFEBBF;">:messiaen2</span>          [1 2 1 2 1 2 1 2]
     <span style="color: #BFEBBF;">:messiaen3</span>          [2 1 1 2 1 1 2 1 1]
     <span style="color: #BFEBBF;">:messiaen4</span>          [1 1 3 1 1 1 3 1]
     <span style="color: #BFEBBF;">:messiaen5</span>          [1 4 1 1 4 1]
     <span style="color: #BFEBBF;">:messiaen6</span>          [2 2 1 1 2 2 1 1]
     <span style="color: #BFEBBF;">:messiaen7</span>          [1 1 1 2 1 1 1 1 2 1]
     <span style="color: #BFEBBF;">:super-locrian</span>      [1 2 1 2 2 2 2]
     <span style="color: #BFEBBF;">:hirajoshi</span>          [2 1 4 1 4]
     <span style="color: #BFEBBF;">:kumoi</span>              [2 1 4 2 3]
     <span style="color: #BFEBBF;">:neapolitan-major</span>   [1 2 2 2 2 2 1]
     <span style="color: #BFEBBF;">:bartok</span>             [2 2 1 2 1 2 2]
     <span style="color: #BFEBBF;">:bhairav</span>            [1 3 1 2 1 3 1]
     <span style="color: #BFEBBF;">:locrian-major</span>      [2 2 1 1 2 2 2]
     <span style="color: #BFEBBF;">:ahirbhairav</span>        [1 3 1 2 2 1 2]
     <span style="color: #BFEBBF;">:enigmatic</span>          [1 3 2 2 2 1 1]
     <span style="color: #BFEBBF;">:neapolitan-minor</span>   [1 2 2 2 1 3 1]
     <span style="color: #BFEBBF;">:pelog</span>              [1 2 4 1 4]
     <span style="color: #BFEBBF;">:augmented2</span>         [1 3 1 3 1 3]
     <span style="color: #BFEBBF;">:scriabin</span>           [1 3 3 2 3]
     <span style="color: #BFEBBF;">:harmonic-major</span>     [2 2 1 2 1 3 1]
     <span style="color: #BFEBBF;">:melodic-minor-desc</span> [2 1 2 2 1 2 2]
     <span style="color: #BFEBBF;">:romanian-minor</span>     [2 1 3 1 2 1 2]
     <span style="color: #BFEBBF;">:hindu</span>              [2 2 1 2 1 2 2]
     <span style="color: #BFEBBF;">:iwato</span>              [1 4 1 4 2]
     <span style="color: #BFEBBF;">:melodic-minor</span>      [2 1 2 2 2 2 1]
     <span style="color: #BFEBBF;">:diminished2</span>        [2 1 2 1 2 1 2 1]
     <span style="color: #BFEBBF;">:marva</span>              [1 3 2 1 2 2 1]
     <span style="color: #BFEBBF;">:melodic-major</span>      [2 2 1 2 1 2 2]
     <span style="color: #BFEBBF;">:indian</span>             [4 1 2 3 2]
     <span style="color: #BFEBBF;">:spanish</span>            [1 3 1 2 1 2 2]
     <span style="color: #BFEBBF;">:prometheus</span>         [2 2 2 5 1]
     <span style="color: #BFEBBF;">:diminished</span>         [1 2 1 2 1 2 1 2]
     <span style="color: #BFEBBF;">:todi</span>               [1 2 3 1 1 3 1]
     <span style="color: #BFEBBF;">:leading-whole</span>      [2 2 2 2 2 1 1]
     <span style="color: #BFEBBF;">:augmented</span>          [3 1 3 1 3 1]
     <span style="color: #BFEBBF;">:purvi</span>              [1 3 2 1 1 3 1]
     <span style="color: #BFEBBF;">:chinese</span>            [4 2 1 4 1]
     <span style="color: #BFEBBF;">:lydian-minor</span>       [2 2 2 1 1 2 2]}))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">resolve-scale</span>
  <span style="color: #9FC59F;">"Either looks the scale up in the map of SCALEs if it's a keyword or</span>
<span style="color: #9FC59F;">  simply returns it unnmodified. Allows users to specify a scale</span>
<span style="color: #9FC59F;">  either as a seq such as [2 2 1 2 2 2 1] or by keyword such</span>
<span style="color: #9FC59F;">  as </span><span style="color: #BFEBBF;">:aeolian</span><span style="color: #9FC59F;">"</span>
  [scale]
  (<span style="color: #F0DFAF; font-weight: bold;">if</span> (keyword? scale)
    (<span style="color: #BFEBBF;">SCALE</span> scale)
    scale))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">scale-field</span>
  <span style="color: #9FC59F;">"Create the note field for a given scale.  Scales are specified with</span>
<span style="color: #9FC59F;">  a keyword representing the key and an optional scale</span>
<span style="color: #9FC59F;">  name (defaulting to </span><span style="color: #BFEBBF;">:major</span><span style="color: #9FC59F;">):</span>
<span style="color: #9FC59F;">  (scale-field </span><span style="color: #BFEBBF;">:g</span><span style="color: #9FC59F;">)</span>
<span style="color: #9FC59F;">  (scale-field </span><span style="color: #BFEBBF;">:g</span><span style="color: #9FC59F;"> </span><span style="color: #BFEBBF;">:minor</span><span style="color: #9FC59F;">)"</span>
  [skey &amp; [sname]]
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> [base (<span style="color: #BFEBBF;">NOTES</span> skey)
        sname (<span style="color: #F0DFAF; font-weight: bold;">or</span> sname <span style="color: #BFEBBF;">:major</span>)
        intervals (<span style="color: #BFEBBF;">SCALE</span> sname)]
    (reverse (next
      (reduce (<span style="color: #F0DFAF; font-weight: bold;">fn</span> [mem interval]
              (<span style="color: #F0DFAF; font-weight: bold;">let</span> [new-note (+ (first mem) interval)]
                (conj mem new-note)))
            (list base)
            (take (* 8 12) (cycle intervals)))))))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">nth-interval</span>
  <span style="color: #9FC59F;">"Return the count of semitones for the nth degree from the start of</span>
<span style="color: #9FC59F;">  the diatonic scale in the specific mode (or ionian/major by</span>
<span style="color: #9FC59F;">  default).</span>

<span style="color: #9FC59F;">  i.e. the ionian/major scale has an interval sequence of 2 2 1 2 2 2</span>
<span style="color: #9FC59F;">       1 therefore the 4th degree is (+ 2 2 1 2) semitones from the</span>
<span style="color: #9FC59F;">       start of the scale."</span>
  ([n] (nth-interval <span style="color: #BFEBBF;">:diatonic</span> n))
  ([scale n]
     (reduce + (take n (cycle (scale <span style="color: #BFEBBF;">SCALE</span>))))))

(<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #DFAF8F;">DEGREE</span> {<span style="color: #BFEBBF;">:i</span>     1
             <span style="color: #BFEBBF;">:ii</span>    2
             <span style="color: #BFEBBF;">:iii</span>   3
             <span style="color: #BFEBBF;">:iv</span>    4
             <span style="color: #BFEBBF;">:v</span>     5
             <span style="color: #BFEBBF;">:vi</span>    6
             <span style="color: #BFEBBF;">:vii</span>   7
             <span style="color: #BFEBBF;">:_</span>     <span style="color: #BFEBBF;">nil</span>})

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">degree-&gt;int</span>
  [degree]
  (<span style="color: #F0DFAF; font-weight: bold;">if</span> (some #{degree} (keys <span style="color: #BFEBBF;">DEGREE</span>))
    (degree <span style="color: #BFEBBF;">DEGREE</span>)
    (<span style="color: #F0DFAF; font-weight: bold;">throw</span> (<span style="color: #7CB8BB;">IllegalArgumentException.</span> (str <span style="color: #CC9393;">"Unable to resolve degree: "</span> degree <span style="color: #CC9393;">". Was expecting a roman numeral in the range </span><span style="color: #BFEBBF;">:i</span><span style="color: #CC9393;"> -&gt; </span><span style="color: #BFEBBF;">:vii</span><span style="color: #CC9393;"> or the nil-note symbol </span><span style="color: #BFEBBF;">:_</span><span style="color: #CC9393;">"</span>)))))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">resolve-degree</span>
  <span style="color: #9FC59F;">"returns a map representing the degree, and the octave semitone</span>
<span style="color: #9FC59F;">  shift (i.e. sharp flat)"</span>
  ([degree] (resolve-degree degree 0 0))
  ([degree octave-shift semitone-shift]
     (<span style="color: #F0DFAF; font-weight: bold;">cond</span>
      (<span style="color: #94BFF3;">.endsWith</span> (name degree) <span style="color: #CC9393;">"-"</span>)
      (resolve-degree (keyword (chop (name degree))) (dec octave-shift) semitone-shift)

      (<span style="color: #94BFF3;">.endsWith</span> (name degree) <span style="color: #CC9393;">"+"</span>)
      (resolve-degree (keyword (chop (name degree))) (inc octave-shift) semitone-shift)

      (<span style="color: #94BFF3;">.endsWith</span> (name degree) <span style="color: #CC9393;">"b"</span>)
      (resolve-degree (keyword (chop (name degree))) octave-shift (dec semitone-shift))

      (<span style="color: #94BFF3;">.endsWith</span> (name degree) <span style="color: #CC9393;">"#"</span>)
      (resolve-degree (keyword (chop (name degree))) octave-shift (inc semitone-shift))

      <span style="color: #BFEBBF;">:default</span>
      (<span style="color: #F0DFAF; font-weight: bold;">let</span> [degree (degree-&gt;int degree)]
        {<span style="color: #BFEBBF;">:degree</span> degree
         <span style="color: #BFEBBF;">:octave-shift</span> octave-shift
         <span style="color: #BFEBBF;">:semitone-shift</span> semitone-shift}))))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">degree-&gt;interval</span>
  <span style="color: #9FC59F;">"Converts the degree of a scale given as a roman numeral keyword and</span>
<span style="color: #9FC59F;">  converts it to the number of semitones from the tonic of</span>
<span style="color: #9FC59F;">  the specified scale.</span>

<span style="color: #9FC59F;">  (degree-&gt;interval </span><span style="color: #BFEBBF;">:ii</span><span style="color: #9FC59F;"> </span><span style="color: #BFEBBF;">:major</span><span style="color: #9FC59F;">) ;=&gt; 2</span>

<span style="color: #9FC59F;">  Trailing #, b, + - represent sharps, flats, octaves up and down</span>
<span style="color: #9FC59F;">  respectively.  An arbitrary number may be added in any order."</span>
  [degree scale]
  (<span style="color: #F0DFAF; font-weight: bold;">cond</span>
    (nil? degree) <span style="color: #BFEBBF;">nil</span>
    (= <span style="color: #BFEBBF;">:_</span> degree) <span style="color: #BFEBBF;">nil</span>

    (number? degree) (nth-interval scale (dec degree))

    (keyword? degree) (<span style="color: #F0DFAF; font-weight: bold;">let</span> [degree     (resolve-degree degree)
                            interval   (nth-interval scale (dec (<span style="color: #BFEBBF;">:degree</span> degree)))
                            oct-shift  (* 12 (<span style="color: #BFEBBF;">:octave-shift</span> degree))
                            semi-shift (<span style="color: #BFEBBF;">:semitone-shift</span> degree)]
                        (+ interval oct-shift semi-shift))))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">degrees-&gt;pitches</span>
  <span style="color: #9FC59F;">"Convert intervals to pitches in MIDI number format.  Supports</span>
<span style="color: #9FC59F;">  nested collections."</span>
  [degrees scale root]
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> [root (note root)]
    (<span style="color: #F0DFAF; font-weight: bold;">when</span> (nil? root)
      (<span style="color: #F0DFAF; font-weight: bold;">throw</span> (<span style="color: #7CB8BB;">IllegalArgumentException.</span> (str <span style="color: #CC9393;">"root resolved to a nil value. degrees-&gt;pitches requires a non-nil root."</span>))))
    (map (<span style="color: #F0DFAF; font-weight: bold;">fn</span> [degree]
           (<span style="color: #F0DFAF; font-weight: bold;">cond</span>
            (coll? degree) (degrees-&gt;pitches degree scale root)
            (nil? degree) <span style="color: #BFEBBF;">nil</span>
            <span style="color: #BFEBBF;">:default</span> (<span style="color: #F0DFAF; font-weight: bold;">if-let</span> [interval (degree-&gt;interval degree scale)]
                       (+ root interval))))
         degrees)))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">resolve-degrees</span>
  <span style="color: #9FC59F;">"Either maps the degrees to integers if they're keywords using the map DEGREE</span>
<span style="color: #9FC59F;">  or leaves them unmodified"</span>
  [degrees]
  (map #(<span style="color: #F0DFAF; font-weight: bold;">if</span> (keyword? <span style="color: #DFAF8F;">%</span>) (<span style="color: #BFEBBF;">DEGREE</span> <span style="color: #DFAF8F;">%</span>) <span style="color: #DFAF8F;">%</span>) degrees))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">scale</span>
  <span style="color: #9FC59F;">"Returns a list of notes for the specified scale. The root must be</span>
<span style="color: #9FC59F;">   in midi note format i.e. </span><span style="color: #BFEBBF;">:C4</span><span style="color: #9FC59F;"> or </span><span style="color: #BFEBBF;">:Bb4</span>


<span style="color: #9FC59F;">   (scale </span><span style="color: #BFEBBF;">:c4</span><span style="color: #9FC59F;"> </span><span style="color: #BFEBBF;">:major</span><span style="color: #9FC59F;">)  ; c major      -&gt; (60 62 64 65 67 69 71 72)</span>
<span style="color: #9FC59F;">   (scale </span><span style="color: #BFEBBF;">:Bb4</span><span style="color: #9FC59F;"> </span><span style="color: #BFEBBF;">:minor</span><span style="color: #9FC59F;">) ; b flat minor -&gt; (70 72 73 75 77 78 80 82)"</span>

  ([root scale-name] (scale root scale-name (range 1 8)))
  ([root scale-name degrees]
     (<span style="color: #F0DFAF; font-weight: bold;">let</span> [root (note root)
           degrees (resolve-degrees degrees)]
       (cons root (map #(+ root (nth-interval scale-name <span style="color: #DFAF8F;">%</span>)) degrees)))))

(<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #DFAF8F;">CHORD</span>
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> [major  #{0 4 7}
        minor  #{0 3 7}
        major7 #{0 4 7 11}
        dom7   #{0 4 7 10}
        minor7 #{0 3 7 10}
        aug    #{0 4 8}
        dim    #{0 3 6}
        dim7   #{0 3 6 9}]
    {<span style="color: #BFEBBF;">:1</span>         #{0}
     <span style="color: #BFEBBF;">:5</span>         #{0 7}
     <span style="color: #BFEBBF;">:+5</span>        #{0 4 8}
     <span style="color: #BFEBBF;">:m+5</span>       #{0 3 8}
     <span style="color: #BFEBBF;">:sus2</span>      #{0 2 7}
     <span style="color: #BFEBBF;">:sus4</span>      #{0 5 7}
     <span style="color: #BFEBBF;">:6</span>         #{0 4 7 9}
     <span style="color: #BFEBBF;">:m6</span>        #{0 3 7 9}
     <span style="color: #BFEBBF;">:7sus2</span>     #{0 2 7 10}
     <span style="color: #BFEBBF;">:7sus4</span>     #{0 5 7 10}
     <span style="color: #BFEBBF;">:7-5</span>       #{0 4 6 10}
     <span style="color: #BFEBBF;">:m7-5</span>      #{0 3 6 10}
     <span style="color: #BFEBBF;">:7+5</span>       #{0 4 8 10}
     <span style="color: #BFEBBF;">:m7+5</span>      #{0 3 8 10}
     <span style="color: #BFEBBF;">:9</span>         #{0 4 7 10 14}
     <span style="color: #BFEBBF;">:m9</span>        #{0 3 7 10 14}
     <span style="color: #BFEBBF;">:m7+9</span>      #{0 3 7 10 14}
     <span style="color: #BFEBBF;">:maj9</span>      #{0 4 7 11 14}
     <span style="color: #BFEBBF;">:9sus4</span>     #{0 5 7 10 14}
     <span style="color: #BFEBBF;">:6*9</span>       #{0 4 7 9 14}
     <span style="color: #BFEBBF;">:m6*9</span>      #{0 3 9 7 14}
     <span style="color: #BFEBBF;">:7-9</span>       #{0 4 7 10 13}
     <span style="color: #BFEBBF;">:m7-9</span>      #{0 3 7 10 13}
     <span style="color: #BFEBBF;">:7-10</span>      #{0 4 7 10 15}
     <span style="color: #BFEBBF;">:9+5</span>       #{0 10 13}
     <span style="color: #BFEBBF;">:m9+5</span>      #{0 10 14}
     <span style="color: #BFEBBF;">:7+5-9</span>     #{0 4 8 10 13}
     <span style="color: #BFEBBF;">:m7+5-9</span>    #{0 3 8 10 13}
     <span style="color: #BFEBBF;">:11</span>        #{0 4 7 10 14 17}
     <span style="color: #BFEBBF;">:m11</span>       #{0 3 7 10 14 17}
     <span style="color: #BFEBBF;">:maj11</span>     #{0 4 7 11 14 17}
     <span style="color: #BFEBBF;">:11+</span>       #{0 4 7 10 14 18}
     <span style="color: #BFEBBF;">:m11+</span>      #{0 3 7 10 14 18}
     <span style="color: #BFEBBF;">:13</span>        #{0 4 7 10 14 17 21}
     <span style="color: #BFEBBF;">:m13</span>       #{0 3 7 10 14 17 21}
     <span style="color: #BFEBBF;">:major</span>      major
     <span style="color: #BFEBBF;">:M</span>          major
     <span style="color: #BFEBBF;">:minor</span>      minor
     <span style="color: #BFEBBF;">:m</span>          minor
     <span style="color: #BFEBBF;">:major7</span>     major7
     <span style="color: #BFEBBF;">:dom7</span>       dom7
     <span style="color: #BFEBBF;">:7</span>          dom7
     <span style="color: #BFEBBF;">:M7</span>         major7
     <span style="color: #BFEBBF;">:minor7</span>     minor7
     <span style="color: #BFEBBF;">:m7</span>         minor7
     <span style="color: #BFEBBF;">:augmented</span>  aug
     <span style="color: #BFEBBF;">:a</span>          aug
     <span style="color: #BFEBBF;">:diminished</span> dim
     <span style="color: #BFEBBF;">:dim</span>        dim
     <span style="color: #BFEBBF;">:i</span>          dim
     <span style="color: #BFEBBF;">:diminished7</span> dim7
     <span style="color: #BFEBBF;">:dim7</span>       dim7
     <span style="color: #BFEBBF;">:i7</span>         dim7}))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">resolve-chord</span>
  <span style="color: #9FC59F;">"Either looks the chord up in the map of CHORDs if it's a keyword or</span>
<span style="color: #9FC59F;">  simply returns it unnmodified. Allows users to specify a chord</span>
<span style="color: #9FC59F;">  either with a set such as #{0 4 7} or by keyword such as </span><span style="color: #BFEBBF;">:major</span><span style="color: #9FC59F;">"</span>
  [chord]
  (<span style="color: #F0DFAF; font-weight: bold;">if</span> (keyword? chord)
    (<span style="color: #BFEBBF;">CHORD</span> chord)
    chord))

(<span style="color: #F0DFAF; font-weight: bold;">defn-</span> <span style="color: #93E0E3;">inc-first</span>
  <span style="color: #9FC59F;">"Remove the first element, increment it by n, and append to seq."</span>
  [elems n]
  (concat (next elems) [(+ n (first elems))]))

(<span style="color: #F0DFAF; font-weight: bold;">defn-</span> <span style="color: #93E0E3;">dec-last</span>
  <span style="color: #9FC59F;">"Remove the last element, decrement it by n, and prepend to seq."</span>
  [elems n]
  (concat [(- (last elems) n)] (next elems)))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">invert-chord</span>
  <span style="color: #9FC59F;">"Move a chord voicing up or down.</span>

<span style="color: #9FC59F;">    ;first inversion</span>
<span style="color: #9FC59F;">    (invert-chord [60 64 67] 1) ;=&gt; (64 67 72)</span>

<span style="color: #9FC59F;">    ; second inversion</span>
<span style="color: #9FC59F;">    (invert-chord [60 64 67] 1) ;=&gt; (67 72 76)</span>
<span style="color: #9FC59F;">  "</span>
  [notes shift]
  (<span style="color: #F0DFAF; font-weight: bold;">cond</span>
    (pos? shift) (<span style="color: #F0DFAF; font-weight: bold;">recur</span> (inc-first notes 12) (dec shift))
    (neg? shift) (<span style="color: #F0DFAF; font-weight: bold;">recur</span> (dec-last notes 12) (inc shift))
    (zero? shift) notes))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">chord</span>
  <span style="color: #9FC59F;">"Returns a set of notes for the specified chord. The root must be in</span>
<span style="color: #9FC59F;">  midi note format i.e. </span><span style="color: #BFEBBF;">:C4.</span>

<span style="color: #9FC59F;">  (chord </span><span style="color: #BFEBBF;">:c4</span><span style="color: #9FC59F;"> </span><span style="color: #BFEBBF;">:major</span><span style="color: #9FC59F;">)  ; c major           -&gt; #{60 64 67}</span>
<span style="color: #9FC59F;">  (chord </span><span style="color: #BFEBBF;">:a4</span><span style="color: #9FC59F;"> </span><span style="color: #BFEBBF;">:minor</span><span style="color: #9FC59F;">)  ; a minor           -&gt; #{57 60 64}</span>
<span style="color: #9FC59F;">  (chord </span><span style="color: #BFEBBF;">:Bb4</span><span style="color: #9FC59F;"> </span><span style="color: #BFEBBF;">:dim</span><span style="color: #9FC59F;">)   ; b flat diminished -&gt; #{70 73 76}</span>
<span style="color: #9FC59F;">  "</span>
  ([root chord-name]
   (chord root chord-name 0))
  ([root chord-name inversion]
     (<span style="color: #F0DFAF; font-weight: bold;">let</span> [root (note root)
           chord (resolve-chord chord-name)
           notes (map #(+ <span style="color: #DFAF8F;">%</span> root) chord)]
       (invert-chord notes inversion))))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">rand-chord</span>
  <span style="color: #9FC59F;">"Generates a random list of MIDI notes with cardinality num-pitches</span>
<span style="color: #9FC59F;">  bound within the range of the specified root and pitch-range and</span>
<span style="color: #9FC59F;">  only containing pitches within the specified chord-name. Similar to</span>
<span style="color: #9FC59F;">  Impromptu's pc:make-chord"</span>
  [root chord-name num-pitches pitch-range]
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> [chord (chord root chord-name)
        root (note root)
        max-pitch (+ pitch-range root)
        roots (range 0 max-pitch 12)
        notes (flatten (map (<span style="color: #F0DFAF; font-weight: bold;">fn</span> [root] (map #(+ root <span style="color: #DFAF8F;">%</span>) chord)) roots))
        notes (take-while #(&lt;= <span style="color: #DFAF8F;">%</span> max-pitch) notes)]
    (sort (choose-n num-pitches notes))))

<span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">midicps</span>
(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">midi-&gt;hz</span>
  <span style="color: #9FC59F;">"Convert a midi note number to a frequency in hz."</span>
  [note]
  (* 440.0 (<span style="color: #7CB8BB;">java.lang.Math</span><span style="color: #DCDCCC; background-color: #3F3F3F;">/</span>pow 2.0 (/ (- note 69.0) 12.0))))

<span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">cpsmidi</span>
(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">hz-&gt;midi</span>
  <span style="color: #9FC59F;">"Convert from a frequency to the nearest midi note number."</span>
  [freq]
  (<span style="color: #7CB8BB;">java.lang.Math</span><span style="color: #DCDCCC; background-color: #3F3F3F;">/</span>round (+ 69
                 (* 12
                    (/ (<span style="color: #7CB8BB;">java.lang.Math</span><span style="color: #DCDCCC; background-color: #3F3F3F;">/</span>log (* freq 0.0022727272727))
                       (<span style="color: #7CB8BB;">java.lang.Math</span><span style="color: #DCDCCC; background-color: #3F3F3F;">/</span>log 2))))))

<span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">ampdb</span>
(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">amp-&gt;db</span>
  <span style="color: #9FC59F;">"Convert linear amplitude to decibels."</span>
  [amp]
  (* 20 (<span style="color: #7CB8BB;">java.lang.Math</span><span style="color: #DCDCCC; background-color: #3F3F3F;">/</span>log10 amp)))

<span style="color: #5F7F5F;">; </span><span style="color: #7F9F7F;">dbamp</span>
(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">db-&gt;amp</span>
  <span style="color: #9FC59F;">"Convert decibels to linear amplitude."</span>
  [db]
  (<span style="color: #7CB8BB;">java.lang.Math</span><span style="color: #DCDCCC; background-color: #3F3F3F;">/</span>exp (* (/ db 20) (<span style="color: #7CB8BB;">java.lang.Math</span><span style="color: #DCDCCC; background-color: #3F3F3F;">/</span>log 10))))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">nth-octave</span>
  <span style="color: #9FC59F;">"Returns the freq n octaves from the supplied reference freq</span>

<span style="color: #9FC59F;">   i.e. (nth-ocatve 440 1) will return 880 which is the freq of the</span>
<span style="color: #9FC59F;">   next octave from 440."</span>
  [freq n]
  (* freq (<span style="color: #7CB8BB;">java.lang.Math</span><span style="color: #DCDCCC; background-color: #3F3F3F;">/</span>pow 2 n)))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">nth-equal-tempered-freq</span>
  <span style="color: #9FC59F;">"Returns the frequency of a given scale interval using an</span>
<span style="color: #9FC59F;">  equal-tempered tuning i.e. dividing all 12 semi-tones equally across</span>
<span style="color: #9FC59F;">  an octave. This is currently the standard tuning."</span>
  [base-freq interval]
  (* base-freq (<span style="color: #7CB8BB;">java.lang.Math</span><span style="color: #DCDCCC; background-color: #3F3F3F;">/</span>pow 2 (/ interval 12))))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">interval-freq</span>
  <span style="color: #9FC59F;">"Returns the frequency of the given interval using the specified</span>
<span style="color: #9FC59F;">  mode and tuning (defaulting to ionian and equal-tempered</span>
<span style="color: #9FC59F;">  respectively)."</span>
  ([base-freq n] (interval-freq base-freq n <span style="color: #BFEBBF;">:ionian</span> <span style="color: #BFEBBF;">:equal-tempered</span>))
  ([base-freq n mode tuning]
     (<span style="color: #F0DFAF; font-weight: bold;">case</span> tuning
           <span style="color: #BFEBBF;">:equal-tempered</span> (nth-equal-tempered-freq base-freq (nth-interval n mode)))))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">find-scale-name</span>
  <span style="color: #9FC59F;">"Return the name of the first matching scale found in SCALE</span>
<span style="color: #9FC59F;">  or nil if not found</span>

<span style="color: #9FC59F;">  ie: (find-scale-name [2 1 2 2 2 2 1]</span>
<span style="color: #9FC59F;">  </span><span style="color: #BFEBBF;">:melodic-minor-asc</span><span style="color: #9FC59F;">"</span>
  [scale]
  (reverse-get <span style="color: #BFEBBF;">SCALE</span> scale))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">find-pitch-class-name</span>
  <span style="color: #9FC59F;">"Given a midi number representing a note, returns the name of the note</span>
<span style="color: #9FC59F;">  independent of octave.</span>

<span style="color: #9FC59F;">  (find-pitch-class-name 62) ;=&gt; </span><span style="color: #BFEBBF;">:D</span>
<span style="color: #9FC59F;">  (find-pitch-class-name 74) ;=&gt; </span><span style="color: #BFEBBF;">:D</span>
<span style="color: #9FC59F;">  (find-pitch-class-name 75) ;=&gt; </span><span style="color: #BFEBBF;">:Eb</span><span style="color: #9FC59F;">"</span>
  [note]
  (REVERSE-NOTES (mod note 12)))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">find-note-name</span>
  [note]
  <span style="color: #CC9393;">"Given a midi number representing a note, returns a keyword</span>
<span style="color: #CC9393;">  representing the note including octave number. Reverse of the fn note.</span>

<span style="color: #CC9393;">  (find-note-name 45) ;=&gt; A2</span>
<span style="color: #CC9393;">  (find-note-name 57) ;=&gt; A3</span>
<span style="color: #CC9393;">  (find-note-name 58) ;=&gt; Bb3"</span>
  (<span style="color: #F0DFAF; font-weight: bold;">when</span> note (<span style="color: #F0DFAF; font-weight: bold;">let</span> [octave (dec (int (/ note 12)))]
               (keyword (str (name (find-pitch-class-name note)) octave)))))

(<span style="color: #F0DFAF; font-weight: bold;">defn-</span> <span style="color: #93E0E3;">fold-note</span>
  <span style="color: #9FC59F;">"Folds note intervals into a 2 octave range so that chords using</span>
<span style="color: #9FC59F;">  notes spread across multiple octaves can be correctly recognised."</span>
  [note]
  (<span style="color: #F0DFAF; font-weight: bold;">if</span> (<span style="color: #F0DFAF; font-weight: bold;">or</span> (&lt; 21 note) (contains? #{20 19 16 12} note))
    (fold-note (- note 12))
     note ))

(<span style="color: #F0DFAF; font-weight: bold;">defn-</span> <span style="color: #93E0E3;">simplify-chord</span>
  <span style="color: #9FC59F;">"Expects notes to contain 0 (the root note) Reduces all notes into 2</span>
<span style="color: #9FC59F;">  octaves. This will allow identification of fancy jazz chords, but</span>
<span style="color: #9FC59F;">  will miss some simple chords if they are spread over more than 1</span>
<span style="color: #9FC59F;">  octave."</span>
  [notes]
  (set (map (<span style="color: #F0DFAF; font-weight: bold;">fn</span> [x] (fold-note x)) notes)))

(<span style="color: #F0DFAF; font-weight: bold;">defn-</span> <span style="color: #93E0E3;">compress-chord</span>
  <span style="color: #9FC59F;">"Expects notes to contain 0 (the root note) Reduces all notes into 1</span>
<span style="color: #9FC59F;">  octave. This will lose all the fancy jazz chords but recognise</span>
<span style="color: #9FC59F;">  sparse multiple octave simple chords"</span>
  [notes]
  (set (map (<span style="color: #F0DFAF; font-weight: bold;">fn</span> [x] (mod x 12)) notes)))

(<span style="color: #F0DFAF; font-weight: bold;">defn-</span> <span style="color: #93E0E3;">select-root</span>
  <span style="color: #9FC59F;">"Adds a new root note below the lowest note present in notes"</span>
  [notes root-index]
  (<span style="color: #F0DFAF; font-weight: bold;">if</span> (&lt; 0 root-index)
    (<span style="color: #F0DFAF; font-weight: bold;">let</span> [new-root (nth (seq (sort notes)) root-index)
         lowest-note (first (sort notes))
         octaves (+ 1 (quot (- new-root lowest-note) 12))]
      (set (cons (- new-root (* octaves 12)) notes)))
    notes))

(<span style="color: #F0DFAF; font-weight: bold;">defn-</span> <span style="color: #93E0E3;">find-chord-with-low-root</span>
  <span style="color: #9FC59F;">"Finds the chord represented by notes</span>
<span style="color: #9FC59F;">   Assumes the root note is the lowest note in notes</span>
<span style="color: #9FC59F;">   notes can be spread over multiple octaves"</span>
  [notes]
  (<span style="color: #F0DFAF; font-weight: bold;">if</span> (&lt; 0 (count notes))
    (<span style="color: #F0DFAF; font-weight: bold;">let</span> [root (first (sort notes))
          adjusted-notes (set (map (<span style="color: #F0DFAF; font-weight: bold;">fn</span> [x] (- x root)) notes ))]
      (<span style="color: #F0DFAF; font-weight: bold;">or</span> (reverse-get <span style="color: #BFEBBF;">CHORD</span> (simplify-chord adjusted-notes))
          (reverse-get <span style="color: #BFEBBF;">CHORD</span> (compress-chord adjusted-notes))))))

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">find-chord</span>
  [notes]
  (<span style="color: #F0DFAF; font-weight: bold;">loop</span> [note 0]
    (<span style="color: #F0DFAF; font-weight: bold;">if</span> (&lt; note (count notes) )
      (<span style="color: #F0DFAF; font-weight: bold;">let</span> [mod-notes (select-root notes note)
            chord  (find-chord-with-low-root mod-notes)
            root (find-pitch-class-name (first (sort mod-notes)))]
       (<span style="color: #F0DFAF; font-weight: bold;">if</span> chord
         {<span style="color: #BFEBBF;">:root</span> root <span style="color: #BFEBBF;">:chord-type</span> chord}
         (<span style="color: #F0DFAF; font-weight: bold;">recur</span> (inc note))))
      <span style="color: #BFEBBF;">nil</span>)))


(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">chord-degree</span>
  <span style="color: #9FC59F;">"Returns the notes constructed by picking thirds in a given scale</span>
<span style="color: #9FC59F;">  from in a given root. Useful if you want to try out playing standard</span>
<span style="color: #9FC59F;">  chord progressions. For example:</span>

<span style="color: #9FC59F;">  (chord-degree </span><span style="color: #BFEBBF;">:i</span><span style="color: #9FC59F;"> </span><span style="color: #BFEBBF;">:c4</span><span style="color: #9FC59F;"> </span><span style="color: #BFEBBF;">:ionian</span><span style="color: #9FC59F;">) ;=&gt; (60 64 67 71)</span>
<span style="color: #9FC59F;">  (chord-degree </span><span style="color: #BFEBBF;">:ii</span><span style="color: #9FC59F;"> </span><span style="color: #BFEBBF;">:c4</span><span style="color: #9FC59F;"> </span><span style="color: #BFEBBF;">:melodic-minor-asc</span><span style="color: #9FC59F;">) ;=&gt; (62 65 69 72)</span>
<span style="color: #9FC59F;">  "</span>
  ([degree root mode]
    (chord-degree degree root mode 4))
  ([degree root mode num-notes]
    (<span style="color: #F0DFAF; font-weight: bold;">let</span> [d-int (degree-&gt;int degree)
          num-degrees (- (+ d-int (* num-notes 2)) 1)]
          (take-nth 2 (drop (degree-&gt;int degree) (scale root mode (range num-degrees)))))))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">* shufflers (randomize a sequence, or notes within a scale, etc.)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">*</span>
<span style="color: #5F7F5F;">;;</span><span style="color: #7F9F7F;">* Sequence generators</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">- probabilistic arpeggiator</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">- take a rhythym seq, note seq, and groove seq</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">- latin sounds</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">- house sounds</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">- minimal techno sounds</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">- drum and bass sounds</span>
<span style="color: #5F7F5F;">;;</span>
<span style="color: #5F7F5F;">;;</span><span style="color: #7F9F7F;">* create a library of sequence modifiers and harmonizers</span>

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">ideas:</span>

<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">represent all notes with midi numbers</span>
<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">represent sequences of notes (i.e. scales) with vectors/lists</span>
<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">represent sequences of durations with vectors/lists</span>
<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">[1 3 5 7]</span>
<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">represent chords with sets</span>
<span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">#{1 3 5}</span>
<span style="color: #5F7F5F;">;;</span>
<span style="color: #5F7F5F;">;;</span><span style="color: #7F9F7F;">[1 3 5 #{1 4 5} 7]</span>
<span style="color: #5F7F5F;">;;</span><span style="color: #7F9F7F;">[1 1 2     6    3]</span>


<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">chromatic notes -&gt; 0-11</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">degrees -&gt; i -&gt; vii</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">chord - concrete: (60 64 67)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">chord - concrete - chromatic notes: (4 7 12)</span>


<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">chord - abstract - chromatic notes: (0 4 7)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">chord - abstract - chromatic notes: (0 4 7)</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">chord - abstract - degrees: (i iii v)</span>
</pre>
</div>
</div></li></ol>
</div>
</div>

<div id="outline-container-orgheadline32" class="outline-3">
<h3 id="orgheadline32"><span class="section-number-3">4.2</span> remember meaningful phenomena</h3>
<div class="outline-text-3" id="text-4-2">
<p>
While randomly generating material can be great fun, sometimes you
strike on something you really like, or you desire to start building
up something more permament and substantial. 
</p>
</div>
<div id="outline-container-orgheadline23" class="outline-4">
<h4 id="orgheadline23"><span class="section-number-4">4.2.1</span> write 6 note voicing to disk</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
Let's use another version of the block from the last section. In this
case, however, we have added a function that will write out data to a
file on disk.
</p>

<div class="org-src-container">

<pre class="src src-clojure"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">Note, we use the mod12 function defined in the last block</span>

(<span style="color: #F0DFAF; font-weight: bold;">let</span> [midis (rand-chord <span style="color: #BFEBBF;">:A2</span> <span style="color: #BFEBBF;">:7+5-9</span> 6 48)]
  (play-piano-chord midis)
  (<span style="color: #F0DFAF; font-weight: bold;">do</span> (println (map find-note-name midis))
      (println midis)
      (println (map mod12 midis))
      (spit <span style="color: #CC9393;">"src/post_tonal_overtone/data/saved-voicings.clj"</span>
            (pr-str midis) <span style="color: #BFEBBF;">:append</span> <span style="color: #BFEBBF;">true</span>)
  ))
</pre>
</div>

<p>
Reading and writing to disk gets rather quickly into some deep and
critical stuff about using programming languages to accomplish things
that will persist. We can think a little about this now, but will
largely skirt the issue until later.
</p>
</div>
</div>

<div id="outline-container-orgheadline24" class="outline-4">
<h4 id="orgheadline24"><span class="section-number-4">4.2.2</span> stateful versions (?)</h4>
<div class="outline-text-4" id="text-4-2-2">
<p>
So the reasons for keeping track of what you have done should be
clear. For example, you might think "This generated chord was
particularly attractive. Wouldn't it be nice to keep track of such
things? And to revist and try out sequences of these things? And then
be able to vary their order? And articulate them differently? Or
subsume them within some larger structure that begins to emerge after
using a bunch of them?"
</p>

<p>
(Or at least, that's what I think!)
</p>

<p>
By capturing our work in emacs and org-mode, we can get a limited sort
of persistence, but presents some problems when we think about
convenience, usability and maintainability.
</p>

<p>
For example, how do you cycle between these two things?
</p>


<div class="org-src-container">

<pre class="src src-clojure">(play-piano-chord '(57 58 65 67 79 85))
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(play-piano-chord '(53 57 58 65 79 81))</span>
</pre>
</div>

<p>
Well, we will need to take advantage of some of Clojure's capabilities
for doing "stateful" things, which may require some kind of swap-ping
or dereferencing of a stateful thing. Huh?
</p>
</div>
</div>

<div id="outline-container-orgheadline25" class="outline-4">
<h4 id="orgheadline25"><span class="section-number-4">4.2.3</span> using an atom and swap to derefence and set a new value</h4>
<div class="outline-text-4" id="text-4-2-3">
<p>
An atom is one of Clojure's techniques for managing "stateful things,"
that is, named "objects" that store or refer to some kind of value.
This can all be rather abstract. Let's look at an example
</p>

<div class="org-src-container">

<pre class="src src-clojure"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">[[__ 57 58 65 67 79 __ 85]</span>
<span style="color: #5F7F5F;">;;  </span><span style="color: #7F9F7F;">[53 57 58 65 __ 79 81]]</span>
(<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #DFAF8F;">a</span> (atom (vec (take 100 (cycle [[57 58 65 67 79 85]
                                    [53 57 58 65 79 81]])))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-clojure">(first (swap! a rest))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-clojure">(play-piano-chord (first (swap! a rest)))
</pre>
</div>

<p>
Most interstingly, let's re-use a bit of that function from above that
prints out some details about our notes.
</p>

<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #F0DFAF; font-weight: bold;">let</span> [midis (first (swap! a rest))]
(<span style="color: #F0DFAF; font-weight: bold;">do</span> (println (map find-note-name midis))
    (println midis)
    (println (map mod12 midis))
    (println (count @a))
    (play-piano-chord midis)
  ))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline26" class="outline-4">
<h4 id="orgheadline26"><span class="section-number-4">4.2.4</span> let's make a cycle with a few more things</h4>
<div class="outline-text-4" id="text-4-2-4">
<p>
If we can alternate between two things in this fashion, if might be
fun to proceed through between a longer sequence of such things
</p>

<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #DFAF8F;">b</span> (atom (vec (take 100 (cycle '((53 55 58 61 77 85)(57 58 65 67 79 85)(45 55 61 65 67 70)(45 61 65 67 70 77)))))))
</pre>
</div>

<p>
Now we work through a series of 4 different voicings of this
interesting chord&gt;
</p>

<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #F0DFAF; font-weight: bold;">let</span> [midis (first (swap! b rest))]
(<span style="color: #F0DFAF; font-weight: bold;">do</span> (println (map find-note-name midis))
    (println midis)
    (println (map mod12 midis))
    (println (count @b))
    (play-piano-chord midis)
  ))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #F0DFAF; font-weight: bold;">definst</span> <span style="color: #93E0E3;">saw1</span> [freq 330 attack 0.3 sustain 0.15 release 0.25 vol 0.2 length 5]
  (* (env-gen (lin attack sustain release) 1 1 0 length <span style="color: #BFEBBF;">FREE</span>)
     (saw freq)
     vol))

(saw1)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">play-chord-saw1</span> [a-chord]
  (<span style="color: #F0DFAF; font-weight: bold;">doseq</span> [note a-chord] (saw1 (midi-&gt;hz note))))
</pre>
</div>

<p>
And now let's read it from another source
</p>
<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #F0DFAF; font-weight: bold;">let</span> [midis (first (swap! b rest))]
(<span style="color: #F0DFAF; font-weight: bold;">do</span> (println (map find-note-name midis))
    (println midis)
    (println (map mod12 midis))
    (println (count @b))
    (play-chord-saw1 midis)
  ))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline27" class="outline-4">
<h4 id="orgheadline27"><span class="section-number-4">4.2.5</span> working with stateful objects without atom management</h4>
<div class="outline-text-4" id="text-4-2-5">
<p>
You CAN do this, but whether you should is another matter. Or rather
an exact understanding of why you should or shouldn't and how to do it
if you do is what ultimately is most important (and involves <code>atoms</code>,
as above).
</p>

<p>
For now, however, let's see how this works, in contrast to using
<code>atoms</code>.
</p>

<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #DFAF8F;">stateful-chord</span> (rand-chord <span style="color: #BFEBBF;">:A2</span> <span style="color: #BFEBBF;">:7+5-9</span> 6 48))

(<span style="color: #F0DFAF; font-weight: bold;">let</span> [midis stateful-chord]
  (play-piano-chord midis)
  (<span style="color: #F0DFAF; font-weight: bold;">do</span> (println (map find-note-name midis))
  (println midis)
  (println (map mod12 midis)
    )))
</pre>
</div>

<p>
See it here again:
</p>

<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #F0DFAF; font-weight: bold;">let</span> [midis stateful-chord]
  (play-piano-chord midis))

stateful-chord
</pre>
</div>

<div class="org-src-container">

<pre class="src src-clojure">stateful-chord
</pre>
</div>

<p>
What's the harm in constantly generating new values for this
"stateful-chord" thing? Perhaps the simplest thing to say is that it
prevents us from learning how to work through Clojure's existing
mechanisms that have been finely-wrought for navigating the complexity
that is potentially involved.
</p>
</div>
</div>

<div id="outline-container-orgheadline28" class="outline-4">
<h4 id="orgheadline28"><span class="section-number-4">4.2.6</span> reading from and writing to disk</h4>
<div class="outline-text-4" id="text-4-2-6">
<p>
Now, as above, we might be interested enough in what we have generated
to save it to disk.
</p>

<div class="org-src-container">

<pre class="src src-clojure">(spit <span style="color: #CC9393;">"src/post_tonal_overtone/data/fave-voicings.clj"</span>
      (pr-str stateful-chord) <span style="color: #BFEBBF;">:append</span> <span style="color: #BFEBBF;">true</span>)
</pre>
</div>

<p>
Which is great, but how do we most conveniently get it back? Reading
it from disk in the following manner doesn't quite work the way you
would want.
</p>

<div class="org-src-container">

<pre class="src src-clojure">(read-string (slurp <span style="color: #CC9393;">"src/post_tonal_overtone/data/fave-voicings.clj"</span>))
</pre>
</div>

<p>
It's great that we getting the first thing we saved to that file, but
there's more there!
</p>

<p>
(In emacs, on my local system, I can confirm this by visiting the following:
</p>

<p>
And C-c C-o to see that the file contains the last "stateful chord"
<a href="file:///Users/b/git-projects/post_tonal_overtone/src/post_tonal_overtone/data/fave-voicings.clj">file:///Users/b/git-projects/post_tonal_overtone/src/post_tonal_overtone/data/fave-voicings.clj</a>
</p>
</div>
</div>
<div id="outline-container-orgheadline29" class="outline-4">
<h4 id="orgheadline29"><span class="section-number-4">4.2.7</span> we want to read-write with streams instead</h4>
<div class="outline-text-4" id="text-4-2-7">
<p>
To start getting into more sophisticated ways of persisting data, we
may need to delve into one of the things that makes Clojure unique:
it's ability to use the underlying mechanisms of the JVM to work with
the local system.
</p>

<p>
(note some of this is derived from section <a href="file:///Users/b/git/org/clojure-books.html#MissingReference">4.9. Reading and Writing
Text Files</a> in the Clojure Cookbook)
</p>

<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #F0DFAF; font-weight: bold;">with-open</span> [w (<span style="color: #7CB8BB;">clojure.java.io</span><span style="color: #DCDCCC; background-color: #3F3F3F;">/</span>writer <span style="color: #CC9393;">"stuff.txt"</span>)]
  (<span style="color: #F0DFAF; font-weight: bold;">doseq</span> [line some-large-seq-of-strings]
    (<span style="color: #94BFF3;">.write</span> w line)
    (<span style="color: #94BFF3;">.newLine</span> w)))
</pre>
</div>
</div>
</div>



<div id="outline-container-orgheadline30" class="outline-4">
<h4 id="orgheadline30"><span class="section-number-4">4.2.8</span> with-open and java file writing interop</h4>
<div class="outline-text-4" id="text-4-2-8">
<p>
In order to delve deeply, we need to understand how to build up a
little larger piece of java interop
</p>
<div class="org-src-container">

<pre class="src src-clojure"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">"src/post_tonal_overtone/transposed-data.clj"</span>

<span style="color: #5F7F5F;">;;  </span><span style="color: #7F9F7F;">/Users/a/git-projects/post_tonal_overtone/src/post_tonal_overtone/data:</span>

 (require '[<span style="color: #7CB8BB;">clojure.java.io</span> <span style="color: #BFEBBF;">:as</span> io])

(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">append-to</span> [f text]
  (<span style="color: #F0DFAF; font-weight: bold;">with-open</span> [w (<span style="color: #7CB8BB;">io</span><span style="color: #DCDCCC; background-color: #3F3F3F;">/</span>writer f <span style="color: #BFEBBF;">:append</span> <span style="color: #BFEBBF;">true</span>)]
    (<span style="color: #F0DFAF; font-weight: bold;">doto</span> w (<span style="color: #94BFF3;">.write</span> text) <span style="color: #94BFF3;">.flush</span>)))
</pre>
</div>

<p>
<code>Append-to</code> is our little wrapper around writing some kind of text to a file that
we pass in as an argument. 
</p>
<div class="org-src-container">

<pre class="src src-clojure">(append-to <span style="color: #CC9393;">"src/post_tonal_overtone/data/short-test.clj"</span> <span style="color: #CC9393;">" still more text with spaces "</span>)
</pre>
</div>


<div class="org-src-container">

<pre class="src src-clojure">(slurp <span style="color: #CC9393;">"src/post_tonal_overtone/data/short-test.clj"</span>)
</pre>
</div>

<p>
While this is nice for proving that we can take arbitrary output from
our programs and store them in a file, we still have to deal with easy
ways of accessing that stuff.
</p>

<p>
For example, using read-string on the <code>slurp</code>-ing that we just did
still leaves the same problem of getting back more than the first
thing.
</p>
<div class="org-src-container">

<pre class="src src-clojure">(read-string (slurp <span style="color: #CC9393;">"src/post_tonal_overtone/data/short-test.clj"</span>))
</pre>
</div>

<p>
What would be nice would be to cycle through the contents of some file
in a piecemeal fashion. What we are bumping into here is a
 <i>sine qua non</i> of programming, which is getting information from a
database.
</p>

<p>
We'll think more deeply about this soon enough.
</p>
</div>
</div>

<div id="outline-container-orgheadline31" class="outline-4">
<h4 id="orgheadline31"><span class="section-number-4">4.2.9</span> developing an understanding of state</h4>
<div class="outline-text-4" id="text-4-2-9">
<p>
One of the main issues in all the above is when there are other
"clients" interacting with the data we have stored to some "object" or
"location." Or what about if you wanted to keep that object available
in clojure and not just on disk somehow, i.e. how should it persist?
</p>

<p>
And what if you wanted to keep that thing around when using clojure
and wanted it to contain an ever expanding list of your favorite
chords?
</p>

<p>
Why, then you would be interested in an honest-to-goodness database!
</p>

<p>
This whole other can of worms is described in an in-progress tutorial
on using Clojure to store info using SQL.
</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline42" class="outline-3">
<h3 id="orgheadline42"><span class="section-number-3">4.3</span> playing a melody involves time idioms</h3>
<div class="outline-text-3" id="text-4-3">
<p>
We've seen a little before about how to get sound to happen with
overtone at a particular time.
</p>
</div>
<div id="outline-container-orgheadline33" class="outline-4">
<h4 id="orgheadline33"><span class="section-number-4">4.3.1</span> start simply with 'this' moment</h4>
<div class="outline-text-4" id="text-4-3-1">
<div class="org-src-container">

<pre class="src src-clojure">(at (now) (play-piano-chord (chord <span style="color: #BFEBBF;">:C4</span> <span style="color: #BFEBBF;">:major</span>)))
</pre>
</div>


<p>
Or now, set-off by 1000 milliseconds.
</p>

<div class="org-src-container">

<pre class="src src-clojure">(at (+ 1000 (now)) (play-piano-chord (chord <span style="color: #BFEBBF;">:C4</span> <span style="color: #BFEBBF;">:major</span>)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline36" class="outline-4">
<h4 id="orgheadline36"><span class="section-number-4">4.3.2</span> using a metronome as timer for more sequenced items</h4>
<div class="outline-text-4" id="text-4-3-2">
<p>
However, we rarely want to schedule just a single event.
</p>
</div>
<ol class="org-ol"><li><a id="orgheadline34"></a>copied standard example<br  /><div class="outline-text-5" id="text-4-3-2-1">
<p>
Here's a version of a common example to demonstrate scheduling several
events.
</p>

<div class="org-src-container">

<pre class="src src-clojure"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">We can play a chord progression on the synth</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">using times:</span>
(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">chord-progression-time</span> []
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> [time (now)]
    (at time (play-piano-chord (chord <span style="color: #BFEBBF;">:C4</span> <span style="color: #BFEBBF;">:major</span>)))
    (at (+ 2000 time) (play-piano-chord (chord <span style="color: #BFEBBF;">:G3</span> <span style="color: #BFEBBF;">:major</span>)))
    (at (+ 3000 time) (play-piano-chord (chord <span style="color: #BFEBBF;">:F3</span> <span style="color: #BFEBBF;">:sus4</span>)))
    (at (+ 4300 time) (play-piano-chord (chord <span style="color: #BFEBBF;">:F3</span> <span style="color: #BFEBBF;">:major</span>)))
    (at (+ 5000 time) (play-piano-chord (chord <span style="color: #BFEBBF;">:G3</span> <span style="color: #BFEBBF;">:major</span>)))))

(chord-progression-time)
</pre>
</div>
</div></li>
<li><a id="orgheadline35"></a>cleaned up standard modified with other chord qualities<br  /><div class="outline-text-5" id="text-4-3-2-2">
<p>
But once we get how this works, we can recognize that it is rather
brittle (not to mention that the chord progression does not especially
reflect the impetus behind this tutorial, which is to think about how
to make music in a post-tonal style. 
</p>

<p>
Let's try out some of the other common chord types overtone makes
available. Additionally we'll take the wise step of removing the
hard-coded times at which the events should start.
</p>

<div class="org-src-container">

<pre class="src src-clojure"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">you will now be able to assign play-times relative to the start</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">time, by passing in a list of "on-times" in milliseconds</span>
(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">my-chord-progression-time</span> [times]
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> [time (now)
        [time1 time2 time3 time4 time5] times]
    (at time (play-piano-chord (chord <span style="color: #BFEBBF;">:C4</span> <span style="color: #BFEBBF;">:dom7</span>)))
    (at (+ time1 time) (play-piano-chord (chord <span style="color: #BFEBBF;">:G3</span> <span style="color: #BFEBBF;">:major7</span>)))
    (at (+ time2 time) (play-piano-chord (chord <span style="color: #BFEBBF;">:F3</span> <span style="color: #BFEBBF;">:sus4</span>)))
    (at (+ time3 time) (play-piano-chord (chord <span style="color: #BFEBBF;">:F3</span> <span style="color: #BFEBBF;">:sus2</span>)))
    (at (+ time4 time) (play-piano-chord (chord <span style="color: #BFEBBF;">:G3</span> <span style="color: #BFEBBF;">:minor7</span>)))
    (at (+ time5 time) (play-piano-chord (chord <span style="color: #BFEBBF;">:C3</span> <span style="color: #BFEBBF;">:dim</span>)))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-clojure">(my-chord-progression-time '(2000 4000 6000 9000 13000 15000))
</pre>
</div>
</div></li></ol>
</div>

<div id="outline-container-orgheadline41" class="outline-4">
<h4 id="orgheadline41"><span class="section-number-4">4.3.3</span> defined <code>play</code> doesn't have an example in the documentation</h4>
<div class="outline-text-4" id="text-4-3-3">
<p>
Let's look at another example of making a function that will play
things for us in time.
</p>
</div>

<ol class="org-ol"><li><a id="orgheadline37"></a>as defined, will play a sequence separated by a specified millisecond amount<br  /><div class="outline-text-5" id="text-4-3-3-1">
<p>
This version has been slightly modified to use the sampled-piano instrument
</p>

<p>
Whereas other timing functions we have used were motivated by the
desire to play chords, here we can demonstrate another kind of common
musical phenomenon: the arpeggio, which is basically just a chord
played spread out over the course of brief span of time.
</p>

<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">play</span> [time notes sep]
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> [note (first notes)]
    (<span style="color: #F0DFAF; font-weight: bold;">when</span> note
      (at time (sampled-piano note)))
    (<span style="color: #F0DFAF; font-weight: bold;">let</span> [next-time (+ time sep)]
      (apply-at next-time play [next-time (rest notes) sep]))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-clojure">(play (now) [60 64 71] 200)
</pre>
</div>

<pre class="example">
#&lt;ScheduledJob id: 1, created-at: Thu 06:28:00s, initial-delay: 198, desc: "Overtone delayed fn", scheduled? true&gt;
</pre>
</div></li>

<li><a id="orgheadline38"></a>nice: provide a large list as an argument and get out a long sequence of notes<br  /><div class="outline-text-5" id="text-4-3-3-2">
<div class="org-src-container">

<pre class="src src-clojure">(recording-start <span style="color: #CC9393;">"/Users/a/Google Drive/wav-file-uploads/arps1.wav"</span>)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-clojure">(play (now) (flatten cmajtriads) 100)
</pre>
</div>



<pre class="example">
:recording-started
</pre>

<div class="org-src-container">

<pre class="src src-clojure">(recording-stop)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-clojure">(play (now) (flatten <span style="color: #7CB8BB;">set-class</span><span style="color: #DCDCCC; background-color: #3F3F3F;">/</span>cmajtriads) 100)
</pre>
</div>


<pre class="example">
/Users/a/Google Drive/wav-file-uploads/arps1.wav
</pre>



<pre class="example">
#&lt;ScheduledJob id: 45, created-at: Sat 01:46:34s, initial-delay: 99, desc: "Overtone delayed fn", scheduled? true&gt;
</pre>


<pre class="example">
#&lt;ScheduledJob id: 4401268, created-at: Wed 04:48:49s, initial-delay: 200, desc: "Overtone delayed fn", scheduled? true&gt;
</pre>
</div></li>

<li><a id="orgheadline39"></a>modified (fails?)<br  /><div class="outline-text-5" id="text-4-3-3-3">
<p>
Why do you need to pass in the time it starts? Any reason that
shouldn't be now? Wouldn't be more useful to be able to vary what
instrument you want to be playing? Here's a version that add an
instrument function.
</p>

<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">my-play</span> [inst notes sep]
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> [note (first notes)
        time (now)]
    (<span style="color: #F0DFAF; font-weight: bold;">when</span> note
      (at time (inst note)))
    (<span style="color: #F0DFAF; font-weight: bold;">let</span> [next-time (+ time sep)]
      (apply-at next-time my-play [inst (rest notes) sep]))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-clojure">(my-play sampled-piano [60 64 67] 2000)
</pre>
</div>
</div></li>

<li><a id="orgheadline40"></a>modify to play with random intervals between notes (fails to reapply)<br  /><div class="outline-text-5" id="text-4-3-3-4">
<p>
This naive attempt to get different rhythms reveals that there is some
misconception in how <code>apply-at</code> works. We'll have to deal with this
question of different rhythms in the next major section.
</p>

<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">new-play</span> [time notes seps]
  (<span style="color: #F0DFAF; font-weight: bold;">let</span> [note (first notes)
        sep (rand-nth seps)]
    (<span style="color: #F0DFAF; font-weight: bold;">when</span> note
      (at time (sampled-piano note))
      (println sep))
    (<span style="color: #F0DFAF; font-weight: bold;">let</span> [next-time (+ time (rand-nth seps))]
      (apply-at next-time play [next-time (rest notes) (rand-nth seps)]))))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-clojure">(new-play (now) (flatten cmajtriads) [100 1000])
</pre>
</div>

<div class="org-src-container">

<pre class="src src-clojure">(new-play (now) (flatten <span style="color: #7CB8BB;">set-class</span><span style="color: #DCDCCC; background-color: #3F3F3F;">/</span>cmajtriads) [100 1000])
</pre>
</div>
</div></li></ol>
</div>
</div>
</div>

<div id="outline-container-orgheadline48" class="outline-2">
<h2 id="orgheadline48"><span class="section-number-2">5</span> generate large databases of musical events</h2>
<div class="outline-text-2" id="text-5">
<p>
Once we start playing these long sequences of some related chords, it
becomes apparent that there are some obvious ways that extend this and
make it more musically interesting.
</p>
</div>
<div id="outline-container-orgheadline44" class="outline-3">
<h3 id="orgheadline44"><span class="section-number-3">5.1</span> transpose triply nested list</h3>
<div class="outline-text-3" id="text-5-1">
<p>
Thus begins the task of working with other structures taken from files
saved to disk.
</p>
<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #F0DFAF; font-weight: bold;">defn</span> <span style="color: #93E0E3;">tn-colls</span> [tn coll-of-colls]
  (map (<span style="color: #F0DFAF; font-weight: bold;">fn</span> [coll] (map #(+ tn <span style="color: #DFAF8F;">%</span>) coll)) coll-of-colls))
</pre>
</div>

<div class="org-src-container">

<pre class="src src-clojure">(first nested-transposed-tetrachords)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-clojure">(first <span style="color: #7CB8BB;">set-class</span><span style="color: #DCDCCC; background-color: #3F3F3F;">/</span>nested-transposed-tetrachords)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-clojure">(tn-colls 60 (first nested-transposed-tetrachords))

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(tn-colls 60 (first set-class/nested-transposed-tetrachords))</span>
</pre>
</div>


<div class="org-src-container">

<pre class="src src-clojure">(subvec (vec nested-transposed-tetrachords) 0 2)
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">(subvec (vec set-class/nested-transposed-tetrachords) 0 2)</span>
</pre>
</div>

<div class="org-src-container">

<pre class="src src-clojure">((<span style="color: #F0DFAF; font-weight: bold;">fn</span> [cococ] (map #(tn-colls 60 <span style="color: #DFAF8F;">%</span>) cococ)) (subvec (vec nested-transposed-tetrachords) 0 3))
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">((fn [cococ] (map #(tn-colls 60 %) cococ)) (subvec (vec set-class/nested-transposed-tetrachords) 0 3))</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline46" class="outline-3">
<h3 id="orgheadline46"><span class="section-number-3">5.2</span> start working with keyworded maps instead of unadorned lists</h3>
<div class="outline-text-3" id="text-5-2">
</div><div id="outline-container-orgheadline45" class="outline-4">
<h4 id="orgheadline45"><span class="section-number-4">5.2.1</span> basic uses of hashes (sets)</h4>
<div class="outline-text-4" id="text-5-2-1">
<div class="org-src-container">

<pre class="src src-clojure">#{<span style="color: #BFEBBF;">:a</span> '(1 2 3) <span style="color: #BFEBBF;">:b</span> '(12 13 14)}
</pre>
</div>

<div class="org-src-container">

<pre class="src src-clojure">(type #{<span style="color: #BFEBBF;">:a</span> '(1 2 3) <span style="color: #BFEBBF;">:b</span> '(12 13 14)})
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgheadline47" class="outline-3">
<h3 id="orgheadline47"><span class="section-number-3">5.3</span> note names vs. midi numbers&#x2013;note vs. find-note-name</h3>
<div class="outline-text-3" id="text-5-3">
<div class="org-src-container">

<pre class="src src-clojure">(note <span style="color: #BFEBBF;">:A4</span>)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-clojure">(find-note-name 21)
</pre>
</div>

<div class="org-src-container">

<pre class="src src-clojure">(note-info <span style="color: #CC9393;">"C#5"</span>)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgheadline49" class="outline-2">
<h2 id="orgheadline49"><span class="section-number-2">6</span> data</h2>
<div class="outline-text-2" id="text-6">
<div class="org-src-container">

<pre class="src src-clojure">(<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #DFAF8F;">cmajtriads</span> '((48 52 55) (48 52 67) (48 52 79) (48 64 55) (48 64 67) (48 64 79) (48 76 55) (48 76 67) (48 76 79) (60 52 55) (60 52 67) (60 52 79) (60 64 55) (60 64 67) (60 64 79) (60 76 55) (60 76 67) (60 76 79) (72 52 55) (72 52 67) (72 52 79) (72 64 55) (72 64 67) (72 64 79) (72 76 55) (72 76 67) (72 76 79)))
(<span style="color: #F0DFAF; font-weight: bold;">def</span> <span style="color: #DFAF8F;">nested-transposed-tetrachords</span> '(((11 12 13 14) (10 11 12 13) (9 10 11 12) (8 9 10 11) (7 8 9 10) (6 7 8 9) (5 6 7 8) (4 5 6 7) (3 4 5 6) (2 3 4 5) (1 2 3 4)) ((11 12 13 15) (10 11 12 14) (9 10 11 13) (8 9 10 12) (7 8 9 11) (6 7 8 10) (5 6 7 9) (4 5 6 8) (3 4 5 7) (2 3 4 6) (1 2 3 5)) ((11 12 14 15) (10 11 13 14) (9 10 12 13) (8 9 11 12) (7 8 10 11) (6 7 9 10) (5 6 8 9) (4 5 7 8) (3 4 6 7) (2 3 5 6) (1 2 4 5)) ((11 12 13 16) (10 11 12 15) (9 10 11 14) (8 9 10 13) (7 8 9 12) (6 7 8 11) (5 6 7 10) (4 5 6 9) (3 4 5 8) (2 3 4 7) (1 2 3 6)) ((11 12 13 17) (10 11 12 16) (9 10 11 15) (8 9 10 14) (7 8 9 13) (6 7 8 12) (5 6 7 11) (4 5 6 10) (3 4 5 9) (2 3 4 8) (1 2 3 7)) ((11 12 13 18) (10 11 12 17) (9 10 11 16) (8 9 10 15) (7 8 9 14) (6 7 8 13) (5 6 7 12) (4 5 6 11) (3 4 5 10) (2 3 4 9) (1 2 3 8)) ((11 12 15 16) (10 11 14 15) (9 10 13 14) (8 9 12 13) (7 8 11 12) (6 7 10 11) (5 6 9 10) (4 5 8 9) (3 4 7 8) (2 3 6 7) (1 2 5 6)) ((11 12 16 17) (10 11 15 16) (9 10 14 15) (8 9 13 14) (7 8 12 13) (6 7 11 12) (5 6 10 11) (4 5 9 10) (3 4 8 9) (2 3 7 8) (1 2 6 7)) ((11 12 17 18) (10 11 16 17) (9 10 15 16) (8 9 14 15) (7 8 13 14) (6 7 12 13) (5 6 11 12) (4 5 10 11) (3 4 9 10) (2 3 8 9) (1 2 7 8)) ((11 13 14 16) (10 12 13 15) (9 11 12 14) (8 10 11 13) (7 9 10 12) (6 8 9 11) (5 7 8 10) (4 6 7 9) (3 5 6 8) (2 4 5 7) (1 3 4 6)) ((11 12 14 16) (10 11 13 15) (9 10 12 14) (8 9 11 13) (7 8 10 12) (6 7 9 11) (5 6 8 10) (4 5 7 9) (3 4 6 8) (2 3 5 7) (1 2 4 6)) ((11 13 14 17) (10 12 13 16) (9 11 12 15) (8 10 11 14) (7 9 10 13) (6 8 9 12) (5 7 8 11) (4 6 7 10) (3 5 6 9) (2 4 5 8) (1 3 4 7)) ((11 12 14 17) (10 11 13 16) (9 10 12 15) (8 9 11 14) (7 8 10 13) (6 7 9 12) (5 6 8 11) (4 5 7 10) (3 4 6 9) (2 3 5 8) (1 2 4 7)) ((11 13 14 18) (10 12 13 17) (9 11 12 16) (8 10 11 15) (7 9 10 14) (6 8 9 13) (5 7 8 12) (4 6 7 11) (3 5 6 10) (2 4 5 9) (1 3 4 8)) ((11 12 14 18) (10 11 13 17) (9 10 12 16) (8 9 11 15) (7 8 10 14) (6 7 9 13) (5 6 8 12) (4 5 7 11) (3 4 6 10) (2 3 5 9) (1 2 4 8)) ((11 12 15 17) (10 11 14 16) (9 10 13 15) (8 9 12 14) (7 8 11 13) (6 7 10 12) (5 6 9 11) (4 5 8 10) (3 4 7 9) (2 3 6 8) (1 2 5 7)) ((11 12 16 18) (10 11 15 17) (9 10 14 16) (8 9 13 15) (7 8 12 14) (6 7 11 13) (5 6 10 12) (4 5 9 11) (3 4 8 10) (2 3 7 9) (1 2 6 8)) ((11 14 15 18) (10 13 14 17) (9 12 13 16) (8 11 12 15) (7 10 11 14) (6 9 10 13) (5 8 9 12) (4 7 8 11) (3 6 7 10) (2 5 6 9) (1 4 5 8)) ((11 12 15 18) (10 11 14 17) (9 10 13 16) (8 9 12 15) (7 8 11 14) (6 7 10 13) (5 6 9 12) (4 5 8 11) (3 4 7 10) (2 3 6 9) (1 2 5 8)) ((11 12 15 19) (10 11 14 18) (9 10 13 17) (8 9 12 16) (7 8 11 15) (6 7 10 14) (5 6 9 13) (4 5 8 12) (3 4 7 11) (2 3 6 10) (1 2 5 9)) ((11 12 16 19) (10 11 15 18) (9 10 14 17) (8 9 13 16) (7 8 12 15) (6 7 11 14) (5 6 10 13) (4 5 9 12) (3 4 8 11) (2 3 7 10) (1 2 6 9)) ((11 13 15 17) (10 12 14 16) (9 11 13 15) (8 10 12 14) (7 9 11 13) (6 8 10 12) (5 7 9 11) (4 6 8 10) (3 5 7 9) (2 4 6 8) (1 3 5 7)) ((11 13 15 18) (10 12 14 17) (9 11 13 16) (8 10 12 15) (7 9 11 14) (6 8 10 13) (5 7 9 12) (4 6 8 11) (3 5 7 10) (2 4 6 9) (1 3 5 8)) ((11 13 16 18) (10 12 15 17) (9 11 14 16) (8 10 13 15) (7 9 12 14) (6 8 11 13) (5 7 10 12) (4 6 9 11) (3 5 8 10) (2 4 7 9) (1 3 6 8)) ((11 13 15 19) (10 12 14 18) (9 11 13 17) (8 10 12 16) (7 9 11 15) (6 8 10 14) (5 7 9 13) (4 6 8 12) (3 5 7 11) (2 4 6 10) (1 3 5 9)) ((11 13 17 19) (10 12 16 18) (9 11 15 17) (8 10 14 16) (7 9 13 15) (6 8 12 14) (5 7 11 13) (4 6 10 12) (3 5 9 11) (2 4 8 10) (1 3 7 9)) ((11 14 16 19) (10 13 15 18) (9 12 14 17) (8 11 13 16) (7 10 12 15) (6 9 11 14) (5 8 10 13) (4 7 9 12) (3 6 8 11) (2 5 7 10) (1 4 6 9)) ((11 13 16 19) (10 12 15 18) (9 11 14 17) (8 10 13 16) (7 9 12 15) (6 8 11 14) (5 7 10 13) (4 6 9 12) (3 5 8 11) (2 4 7 10) (1 3 6 9)) ((11 14 17 20) (10 13 16 19) (9 12 15 18) (8 11 14 17) (7 10 13 16) (6 9 12 15) (5 8 11 14) (4 7 10 13) (3 6 9 12) (2 5 8 11) (1 4 7 10))))
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: b</p>
<p class="date">Created: 2016-12-02 Fri 15:25</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
